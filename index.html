<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Vereinsmeisterschaft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION - HIER DEINE CONFIG EINTRAGEN!
        // ============================================
        const firebaseConfig = {
            apiKey: "DEINE_API_KEY",
            authDomain: "DEIN_PROJECT.firebaseapp.com",
            projectId: "DEIN_PROJECT_ID",
            storageBucket: "DEIN_PROJECT.appspot.com",
            messagingSenderId: "DEINE_SENDER_ID",
            appId: "DEINE_APP_ID"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            currentPage: 'home',
            user: null,
            players: [],
            singlesMatches: [],
            doublesMatches: [],
            pyramid: { levels: [] },
            challenges: [],
            editingPlayer: null,
            matchEntry: {
                set1P1: '', set1P2: '',
                set2P1: '', set2P2: '',
                set3P1: '', set3P2: ''
            }
        };

        // ============================================
        // FIREBASE LISTENERS
        // ============================================
        function initFirebaseListeners() {
            auth.onAuthStateChanged(user => {
                state.user = user;
                render();
            });

            db.collection('players').orderBy('name').onSnapshot(snapshot => {
                state.players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });

            db.collection('singlesMatches').orderBy('date', 'desc').onSnapshot(snapshot => {
                state.singlesMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });

            db.collection('doublesMatches').orderBy('date', 'desc').onSnapshot(snapshot => {
                state.doublesMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });

            db.collection('pyramid').doc('current').onSnapshot(doc => {
                if (doc.exists) {
                    state.pyramid = doc.data();
                }
                render();
            });

            db.collection('challenges').where('status', '==', 'pending').onSnapshot(snapshot => {
                state.challenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function getPlayerName(playerId) {
            const player = state.players.find(p => p.id === playerId);
            return player ? player.name : 'Unbekannt';
        }

        function getGroupPlayers(groupNum) {
            return state.players.filter(p => p.singlesGroup === groupNum);
        }

        function calculateStandings(groupNum) {
            const players = getGroupPlayers(groupNum);
            const stats = {};
            
            players.forEach(p => {
                stats[p.id] = {
                    id: p.id,
                    name: p.name,
                    matches: 0,
                    points: 0,
                    setsWon: 0,
                    setsLost: 0
                };
            });

            state.singlesMatches.forEach(match => {
                if (!match.sets) return;
                
                const p1 = match.player1Id;
                const p2 = match.player2Id;
                
                if (!stats[p1] || !stats[p2]) return;

                const sets = match.sets;
                let p1Sets = 0, p2Sets = 0;

                sets.forEach(set => {
                    if (set.p1 > set.p2) p1Sets++;
                    else p2Sets++;
                });

                stats[p1].matches++;
                stats[p2].matches++;
                stats[p1].setsWon += p1Sets;
                stats[p1].setsLost += p2Sets;
                stats[p2].setsWon += p2Sets;
                stats[p2].setsLost += p1Sets;

                if (p1Sets > p2Sets) {
                    stats[p1].points += (p1Sets === 2 && p2Sets === 0) ? 3 : 2;
                    stats[p2].points += (p2Sets === 1) ? 1 : 0;
                } else {
                    stats[p2].points += (p2Sets === 2 && p1Sets === 0) ? 3 : 2;
                    stats[p1].points += (p1Sets === 1) ? 1 : 0;
                }
            });

            return Object.values(stats).sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                const aDiff = a.setsWon - a.setsLost;
                const bDiff = b.setsWon - b.setsLost;
                return bDiff - aDiff;
            });
        }

        function validateSet(p1, p2) {
            const n1 = parseInt(p1);
            const n2 = parseInt(p2);
            
            if (isNaN(n1) || isNaN(n2)) return false;
            if (n1 < 0 || n2 < 0) return false;
            
            // Einer muss mindestens 21 haben
            if (n1 < 21 && n2 < 21) return false;
            
            // Gewinner muss 2 Punkte Vorsprung haben ab 20:20
            if (n1 >= 20 && n2 >= 20) {
                if (Math.abs(n1 - n2) < 2) return false;
            }
            
            // Maximal 30 Punkte
            if (n1 > 30 || n2 > 30) return false;
            
            return true;
        }

        function updateMatchEntry(field, value) {
            state.matchEntry[field] = value;
            
            // Check if third set should be disabled
            const s1p1 = parseInt(state.matchEntry.set1P1);
            const s1p2 = parseInt(state.matchEntry.set1P2);
            const s2p1 = parseInt(state.matchEntry.set2P1);
            const s2p2 = parseInt(state.matchEntry.set2P2);
            
            if (!isNaN(s1p1) && !isNaN(s1p2) && !isNaN(s2p1) && !isNaN(s2p2)) {
                const set1Winner = s1p1 > s1p2 ? 'p1' : 'p2';
                const set2Winner = s2p1 > s2p2 ? 'p1' : 'p2';
                
                // Disable set 3 if someone won 2:0
                if (set1Winner === set2Winner) {
                    state.matchEntry.set3Disabled = true;
                    state.matchEntry.set3P1 = '';
                    state.matchEntry.set3P2 = '';
                } else {
                    state.matchEntry.set3Disabled = false;
                }
            }
            
            render();
        }

        function getPyramidLevelForPosition(position) {
            let level = 1;
            let posInLevel = position;
            
            while (posInLevel > level) {
                posInLevel -= level;
                level++;
            }
            
            return { level, positionInLevel: posInLevel };
        }

        function buildPyramidLevels(positions) {
            const levels = [];
            let idx = 0;
            let levelNum = 1;
            
            while (idx < positions.length) {
                const levelPlayers = positions.slice(idx, idx + levelNum);
                levels.push(levelPlayers);
                idx += levelNum;
                levelNum++;
            }
            
            return levels;
        }

        // ============================================
        // ICONS
        // ============================================
        const icons = {
            trophy: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>',
            pyramid: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>',
            users: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>',
            settings: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
            plus: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
            edit: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>',
            trash: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>',
            login: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>',
            logout: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>',
            save: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
            x: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
        };

        // ============================================
        // COMPONENTS
        // ============================================
        function Navigation() {
            return `
                <nav class="bg-white shadow-lg">
                    <div class="container mx-auto px-4">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center space-x-8">
                                <h1 class="text-2xl font-bold text-indigo-600 cursor-pointer" onclick="navigateTo('home')">üè∏ Vereinsmeisterschaft</h1>
                                
                                <div class="flex space-x-4">
                                    <button onclick="navigateTo('singles')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${state.currentPage === 'singles' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                                        ${icons.trophy}
                                        <span class="font-medium">Einzel</span>
                                    </button>
                                    <button onclick="navigateTo('doubles')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${state.currentPage === 'doubles' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                                        ${icons.pyramid}
                                        <span class="font-medium">Doppel</span>
                                    </button>
                                    <button onclick="navigateTo('players')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${state.currentPage === 'players' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                                        ${icons.users}
                                        <span class="font-medium">Spieler</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                ${state.user ? `
                                    <button onclick="navigateTo('admin')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${state.currentPage === 'admin' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                                        ${icons.settings}
                                        <span class="font-medium">Admin</span>
                                    </button>
                                    <button onclick="handleLogout()" class="flex items-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                        ${icons.logout}
                                        <span>Logout</span>
                                    </button>
                                ` : `
                                    <button onclick="navigateTo('admin')" class="flex items-center space-x-2 px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                        ${icons.login}
                                        <span>Admin Login</span>
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </nav>
            `;
        }

        function HomePage() {
            const recentMatches = [...state.singlesMatches, ...state.doublesMatches]
                .sort((a, b) => {
                    const aTime = a.date?.seconds || 0;
                    const bTime = b.date?.seconds || 0;
                    return bTime - aTime;
                })
                .slice(0, 5);

            return `
                <div class="space-y-8">
                    <div class="text-center">
                        <h2 class="text-4xl font-bold text-gray-800 mb-4">Willkommen zur Vereinsmeisterschaft</h2>
                        <p class="text-xl text-gray-600">Aktuell ${state.players.length} registrierte Spieler</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div onclick="navigateTo('singles')" class="bg-white rounded-xl shadow-lg p-8 cursor-pointer hover:shadow-xl transition-shadow">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="text-yellow-500">${icons.trophy}</div>
                                <h3 class="text-2xl font-bold text-gray-800">Einzel-Turnier</h3>
                            </div>
                            <p class="text-gray-600">Gruppenphasen mit anschlie√üendem K.O.-System</p>
                        </div>
                        
                        <div onclick="navigateTo('doubles')" class="bg-white rounded-xl shadow-lg p-8 cursor-pointer hover:shadow-xl transition-shadow">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="text-blue-500">${icons.pyramid}</div>
                                <h3 class="text-2xl font-bold text-gray-800">Doppel-Pyramide</h3>
                            </div>
                            <p class="text-gray-600">Herausforderungs-System mit dynamischer Rangfolge</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Letzte Ergebnisse</h3>
                        ${recentMatches.length === 0 ? `
                            <p class="text-gray-500 text-center py-8">Noch keine Spiele eingetragen</p>
                        ` : `
                            <div class="space-y-3">
                                ${recentMatches.map(match => {
                                    const scoreText = match.sets ? 
                                        match.sets.map(s => `${s.p1}:${s.p2}`).join(', ') : 
                                        'Ausstehend';
                                    return `
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <span class="font-medium">${getPlayerName(match.player1Id)} vs ${getPlayerName(match.player2Id)}</span>
                                            <span class="text-indigo-600 font-bold">${scoreText}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function SinglesPage() {
            const group1 = calculateStandings(1);
            const group2 = calculateStandings(2);

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Einzel-Turnier</h2>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            ${GroupTable(1, group1)}
                            ${GroupTable(2, group2)}
                        </div>
                        
                        ${state.user ? SinglesMatchEntry() : ''}
                    </div>
                </div>
            `;
        }

        function GroupTable(groupNum, standings) {
            return `
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Gruppe ${groupNum}</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-gray-600 border-b">
                                <th class="pb-2">Platz</th>
                                <th class="pb-2">Spieler</th>
                                <th class="pb-2">Sp</th>
                                <th class="pb-2">Pkt</th>
                                <th class="pb-2">S√§tze</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${standings.length === 0 ? `
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-gray-500">Keine Spieler in Gruppe ${groupNum}</td>
                                </tr>
                            ` : standings.map((player, idx) => `
                                <tr class="border-b border-gray-200">
                                    <td class="py-2 font-bold">${idx + 1}</td>
                                    <td class="py-2">${player.name}</td>
                                    <td class="py-2">${player.matches}</td>
                                    <td class="py-2 font-semibold">${player.points}</td>
                                    <td class="py-2">${player.setsWon}:${player.setsLost}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function SinglesMatchEntry() {
            const group1Players = getGroupPlayers(1);
            const group2Players = getGroupPlayers(2);
            const allSinglesPlayers = [...group1Players, ...group2Players];

            return `
                <div class="p-4 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-3">Neues Einzel-Spiel eintragen</h4>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <select id="singlesP1" class="px-3 py-2 border rounded-lg">
                            <option value="">Spieler 1 w√§hlen</option>
                            ${allSinglesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                        <select id="singlesP2" class="px-3 py-2 border rounded-lg">
                            <option value="">Spieler 2 w√§hlen</option>
                            ${allSinglesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Spieler 1</label>
                                <input type="number" id="set1P1" min="0" max="30" 
                                    oninput="updateMatchEntry('set1P1', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Spieler 2</label>
                                <input type="number" id="set1P2" min="0" max="30"
                                    oninput="updateMatchEntry('set1P2', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Spieler 1</label>
                                <input type="number" id="set2P1" min="0" max="30"
                                    oninput="updateMatchEntry('set2P1', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Spieler 2</label>
                                <input type="number" id="set2P2" min="0" max="30"
                                    oninput="updateMatchEntry('set2P2', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Spieler 1</label>
                                <input type="number" id="set3P1" min="0" max="30"
                                    oninput="updateMatchEntry('set3P1', this.value)"
                                    ${state.matchEntry.set3Disabled ? 'disabled' : ''}
                                    class="w-full px-3 py-2 border rounded-lg ${state.matchEntry.set3Disabled ? 'bg-gray-200' : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Spieler 2</label>
                                <input type="number" id="set3P2" min="0" max="30"
                                    oninput="updateMatchEntry('set3P2', this.value)"
                                    ${state.matchEntry.set3Disabled ? 'disabled' : ''}
                                    class="w-full px-3 py-2 border rounded-lg ${state.matchEntry.set3Disabled ? 'bg-gray-200' : ''}">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="addSinglesMatch()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Spiel eintragen
                    </button>
                </div>
            `;
        }

        function DoublesPage() {
            const levels = state.pyramid.levels || [];

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Doppel-Pyramide</h2>
                        
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold mb-3">Aktuelle Rangfolge</h3>
                            ${levels.length === 0
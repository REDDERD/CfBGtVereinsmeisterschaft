<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Badminton Vereinsmeisterschaft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  </head>

  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyArdTajlSvaUqWh4-LFrhJXOKukn9iecZs",
        authDomain: "cfbgtvereinsmeisterschaft.firebaseapp.com",
        projectId: "cfbgtvereinsmeisterschaft",
        storageBucket: "cfbgtvereinsmeisterschaft.firebasestorage.app",
        messagingSenderId: "527308111102",
        appId: "1:527308111102:web:ef1b52153dd75a6a0c79af",
        measurementId: "G-QKGNPLQN20",
      };

      // Firebase initialisieren
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // ============================================
      // STATE MANAGEMENT
      // ============================================
      const state = {
        currentPage: "home",
        user: null,
        players: [],
        singlesMatches: [],
        doublesMatches: [],
        knockoutMatches: [], // NEU: K.O.-Phasen Spiele
        pyramid: { levels: [] },
        challenges: [],
        editingPlayer: null,
        selectedPlayerId: null,
        prefilledDoubles: null, // For prefilling doubles match from challenge
        adminTab: "players", // Current admin tab: 'players', 'singles', 'singlesTable', 'doubles', 'doublesRanking'
        singlesSearchQuery: "",
        doublesSearchQuery: "",
        mobileMenuOpen: false,
        singlesPhase: "group", // 'group' or 'knockout'
        knockoutPhaseActive: false, // Wird true wenn Admin KO-Phase aktiviert
        knockoutBracket: {
          round16: [], // Achtelfinale
          quarter: [], // Viertelfinale
          semi: [], // Halbfinale
          thirdPlace: {}, // Spiel um Platz 3
          final: {}, // Finale
        },
        knockoutConfig: {}, // Positions-basierte Konfiguration
        frozenStandings: null, // NEU: Eingefrorene Gruppenphase-Tabelle
        singlesView: "group", // Was auf der Singles-Seite angezeigt wird
        knockoutEntryMatch: null, // NEU: Aktuell bearbeitetes K.O.-Spiel
        matchEntry: {
          set1P1: "",
          set1P2: "",
          set2P1: "",
          set2P2: "",
          set3P1: "",
          set3P2: "",
          set3Disabled: false,
        },
      };

      // ============================================
      // FIREBASE LISTENERS
      // ============================================
      function initFirebaseListeners() {
        auth.onAuthStateChanged((user) => {
          state.user = user;
          render();
        });

        db.collection("players")
          .orderBy("name")
          .onSnapshot((snapshot) => {
            state.players = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            render();
          });

        db.collection("singlesMatches")
          .orderBy("date", "desc")
          .onSnapshot((snapshot) => {
            state.singlesMatches = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            render();
          });

        db.collection("doublesMatches")
          .orderBy("date", "desc")
          .onSnapshot((snapshot) => {
            state.doublesMatches = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            render();
          });

        db.collection("pyramid")
          .doc("current")
          .onSnapshot((doc) => {
            if (doc.exists) {
              state.pyramid = doc.data();
            }
            render();
          });

        db.collection("challenges")
          .where("status", "==", "pending")
          .onSnapshot((snapshot) => {
            state.challenges = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            render();
          });

        db.collection("settings")
          .doc("knockout")
          .onSnapshot((doc) => {
            if (doc.exists) {
              state.knockoutPhaseActive = doc.data().active || false;
              state.frozenStandings = doc.data().frozenStandings || null;
              render();
            }
          });

        // NEU: Listener f√ºr K.O.-Phasen Spiele
        db.collection("knockoutMatches")
          .orderBy("createdAt", "desc")
          .onSnapshot((snapshot) => {
            state.knockoutMatches = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            render();
          });

        db.collection("settings")
          .doc("knockoutConfig")
          .onSnapshot((doc) => {
            if (doc.exists) {
              state.knockoutConfig = doc.data();
              render();
            }
          });
      }

      // ============================================
      // HELPER FUNCTIONS
      // ============================================
      function getPlayerName(playerId) {
        const player = state.players.find((p) => p.id === playerId);
        return player ? player.name : "Unbekannt";
      }

      function getGroupPlayers(groupNum) {
        return state.players.filter((p) => p.singlesGroup === groupNum);
      }

      function calculateStandings(groupNum) {
        const players = getGroupPlayers(groupNum);
        const stats = {};

        players.forEach((p) => {
          stats[p.id] = {
            id: p.id,
            name: p.name,
            matches: 0,
            points: 0,
            setsWon: 0,
            setsLost: 0,
          };
        });

        state.singlesMatches.forEach((match) => {
          if (!match.sets) return;

          const p1 = match.player1Id;
          const p2 = match.player2Id;

          if (!stats[p1] || !stats[p2]) return;

          const sets = match.sets;
          let p1Sets = 0,
            p2Sets = 0;

          sets.forEach((set) => {
            if (set.p1 > set.p2) p1Sets++;
            else p2Sets++;
          });

          stats[p1].matches++;
          stats[p2].matches++;
          stats[p1].setsWon += p1Sets;
          stats[p1].setsLost += p2Sets;
          stats[p2].setsWon += p2Sets;
          stats[p2].setsLost += p1Sets;

          if (p1Sets > p2Sets) {
            stats[p1].points += p1Sets === 2 && p2Sets === 0 ? 3 : 2;
            stats[p2].points += p2Sets === 1 ? 1 : 0;
          } else {
            stats[p2].points += p2Sets === 2 && p1Sets === 0 ? 3 : 2;
            stats[p1].points += p1Sets === 1 ? 1 : 0;
          }
        });

        return Object.values(stats).sort((a, b) => {
          if (b.points !== a.points) return b.points - a.points;
          const aDiff = a.setsWon - a.setsLost;
          const bDiff = b.setsWon - b.setsLost;
          return bDiff - aDiff;
        });
      }

      function validateSet(p1, p2) {
        const n1 = parseInt(p1);
        const n2 = parseInt(p2);

        if (isNaN(n1) || isNaN(n2)) return false;
        if (n1 < 0 || n2 < 0) return false;

        // Einer muss mindestens 21 haben
        if (n1 < 21 && n2 < 21) return false;

        // Gewinner muss 2 Punkte Vorsprung haben ab 20:20
        if (n1 >= 20 && n2 >= 20) {
          if (Math.abs(n1 - n2) < 2) return false;
        }

        // Maximal 30 Punkte
        if (n1 > 30 || n2 > 30) return false;

        return true;
      }

      function updateMatchEntry(field, value) {
        state.matchEntry[field] = value;

        // Check if third set should be disabled
        const s1p1 = parseInt(state.matchEntry.set1P1);
        const s1p2 = parseInt(state.matchEntry.set1P2);
        const s2p1 = parseInt(state.matchEntry.set2P1);
        const s2p2 = parseInt(state.matchEntry.set2P2);

        if (!isNaN(s1p1) && !isNaN(s1p2) && !isNaN(s2p1) && !isNaN(s2p2)) {
          const set1Winner = s1p1 > s1p2 ? "p1" : "p2";
          const set2Winner = s2p1 > s2p2 ? "p1" : "p2";

          // Disable set 3 if someone won 2:0
          if (set1Winner === set2Winner) {
            state.matchEntry.set3Disabled = true;
          } else {
            state.matchEntry.set3Disabled = false;
          }
        }

        // Don't render, just update the disabled state
        const set3P1Input = document.getElementById("set3P1");
        const set3P2Input = document.getElementById("set3P2");
        if (set3P1Input && set3P2Input) {
          if (state.matchEntry.set3Disabled) {
            set3P1Input.disabled = true;
            set3P2Input.disabled = true;
            set3P1Input.value = "";
            set3P2Input.value = "";
            set3P1Input.classList.add("bg-gray-200");
            set3P2Input.classList.add("bg-gray-200");
          } else {
            set3P1Input.disabled = false;
            set3P2Input.disabled = false;
            set3P1Input.classList.remove("bg-gray-200");
            set3P2Input.classList.remove("bg-gray-200");
          }
        }
      }

      function getPyramidLevelForPosition(position) {
        let level = 1;
        let posInLevel = position;

        while (posInLevel > level) {
          posInLevel -= level;
          level++;
        }

        return { level, positionInLevel: posInLevel };
      }

      function buildPyramidLevels(positions) {
        const levels = {};
        let idx = 0;
        let levelNum = 1;

        while (idx < positions.length) {
          const levelPlayers = positions.slice(idx, idx + levelNum);
          levels[`level${levelNum}`] = levelPlayers;
          idx += levelNum;
          levelNum++;
        }

        return levels;
      }

      function pyramidLevelsToArray(pyramidData) {
        if (!pyramidData) {
          return [];
        }

        const levels = [];
        let levelNum = 1;

        while (pyramidData[`level${levelNum}`]) {
          const levelData = pyramidData[`level${levelNum}`];

          // Firebase stores it as array already!
          if (Array.isArray(levelData)) {
            levels.push(levelData);
          } else if (typeof levelData === "string") {
            // Fallback for string format
            levels.push(levelData.split(","));
          } else {
            console.warn(`Level ${levelNum} unexpected type:`, levelData);
          }
          levelNum++;
        }

        return levels;
      }

      // Load pyramid manually
      async function loadPyramid() {
        try {
          const doc = await db.collection("pyramid").doc("current").get();
          if (doc.exists) {
            const data = doc.data();
            const levelsArray = pyramidLevelsToArray(data);

            // Check if there are new players that need to be added
            const doublesPlayers = state.players.filter((p) => p.doublesPool);
            const doublesPlayerIds = doublesPlayers.map((p) => p.id);

            // Get current players in pyramid
            let flatPositions = [];
            levelsArray.forEach((level) => {
              level.forEach((playerId) => {
                flatPositions.push(playerId);
              });
            });

            // Find new players not in pyramid
            const newPlayers = doublesPlayerIds.filter(
              (id) => !flatPositions.includes(id)
            );

            if (newPlayers.length > 0) {
              // Add new players to the bottom
              flatPositions = [...flatPositions, ...newPlayers];

              // Rebuild pyramid structure
              const newPyramidData = {};
              let idx = 0;
              let levelNum = 1;

              while (idx < flatPositions.length) {
                const levelPlayers = flatPositions.slice(idx, idx + levelNum);
                newPyramidData[`level${levelNum}`] = levelPlayers;
                idx += levelNum;
                levelNum++;
              }

              // Save updated pyramid
              await db
                .collection("pyramid")
                .doc("current")
                .set({
                  ...newPyramidData,
                  lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                });

              // Reload after update
              const updatedDoc = await db
                .collection("pyramid")
                .doc("current")
                .get();
              if (updatedDoc.exists) {
                const updatedData = updatedDoc.data();
                const updatedLevels = pyramidLevelsToArray(updatedData);
                state.pyramid = {
                  levels: updatedLevels,
                };
              }
            } else {
              state.pyramid = {
                levels: levelsArray,
              };
            }

            render();
          } else {
            state.pyramid = { levels: [] };
            render();
          }
        } catch (error) {
          console.error("‚ùå Error loading pyramid:", error);
        }
      }

      // ============================================
      // ICONS
      // ============================================
      const icons = {
        trophy:
          '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>',
        pyramid:
          '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>',
        users:
          '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>',
        settings:
          '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
        plus: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
        edit: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>',
        trash:
          '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>',
        login:
          '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>',
        logout:
          '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>',
        save: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
        x: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
      };

      // ============================================
      // COMPONENTS
      // ============================================
      function Navigation() {
        return `
                <nav class="bg-white shadow-lg">
                    <div class="container mx-auto px-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between py-4 md:h-16">
                            <div class="flex items-center justify-between mb-4 md:mb-0">
                                <h1 class="text-xl md:text-2xl font-bold text-indigo-600 cursor-pointer" onclick="navigateTo('home')">üè∏ Vereinsmeisterschaft</h1>
                                <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <div id="mobileMenu" class="flex-col md:flex-row md:flex items-start md:items-center space-y-2 md:space-y-0 md:space-x-2 ${
                              state.mobileMenuOpen ? "flex" : "hidden md:flex"
                            }">
                                <button onclick="navigateTo('singles')" class="w-full md:w-auto flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${
                                  state.currentPage === "singles"
                                    ? "bg-indigo-600 text-white"
                                    : "text-gray-700 hover:bg-gray-100"
                                }">
                                    ${icons.trophy}
                                    <span class="font-medium">Einzel</span>
                                </button>
                                <button onclick="navigateTo('doubles')" class="w-full md:w-auto flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${
                                  state.currentPage === "doubles"
                                    ? "bg-indigo-600 text-white"
                                    : "text-gray-700 hover:bg-gray-100"
                                }">
                                    ${icons.pyramid}
                                    <span class="font-medium">Doppel</span>
                                </button>
                                <button onclick="navigateTo('challenges')" class="w-full md:w-auto flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${
                                  state.currentPage === "challenges"
                                    ? "bg-indigo-600 text-white"
                                    : "text-gray-700 hover:bg-gray-100"
                                }">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                    <span class="font-medium">Herausforderungen</span>
                                </button>
                                <button onclick="navigateTo('players')" class="w-full md:w-auto flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${
                                  state.currentPage === "players"
                                    ? "bg-indigo-600 text-white"
                                    : "text-gray-700 hover:bg-gray-100"
                                }">
                                    ${icons.users}
                                    <span class="font-medium">Spieler</span>
                                </button>
                                
                                ${
                                  state.user
                                    ? `
                                    <button onclick="navigateTo('admin')" class="w-full md:w-auto flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${
                                      state.currentPage === "admin"
                                        ? "bg-indigo-600 text-white"
                                        : "text-gray-700 hover:bg-gray-100"
                                    }">
                                        ${icons.settings}
                                        <span class="font-medium">Admin</span>
                                    </button>
                                    <button onclick="handleLogout()" class="w-full md:w-auto flex items-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                        ${icons.logout}
                                        <span>Logout</span>
                                    </button>
                                `
                                    : `
                                    <button onclick="navigateTo('admin')" class="w-full md:w-auto flex items-center space-x-2 px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                        ${icons.login}
                                        <span>Admin Login</span>
                                    </button>
                                `
                                }
                            </div>
                        </div>
                    </div>
                </nav>
            `;
      }

      function HomePage() {
        const recentMatches = [...state.singlesMatches, ...state.doublesMatches]
          .sort((a, b) => {
            const aTime = a.date?.seconds || 0;
            const bTime = b.date?.seconds || 0;
            return bTime - aTime;
          })
          .slice(0, 5);

        // Get today's and overdue challenges
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayTimestamp = today.getTime() / 1000;

        const upcomingChallenges = state.challenges.filter((c) => {
          if (c.status === "completed") return false;
          const challengeDate = c.date?.seconds || 0;
          return challengeDate <= todayTimestamp + 86400; // Today and overdue
        });

        return `
                <div class="space-y-8">
                    <div class="text-center">
                        <h2 class="text-2xl md:text-4xl font-bold text-gray-800 mb-4">Willkommen zur Vereinsmeisterschaft</h2>
                        <p class="text-lg md:text-xl text-gray-600">Aktuell ${
                          state.players.length
                        } registrierte Spieler</p>
                    </div>
                    
                    ${
                      upcomingChallenges.length > 0
                        ? `
                        <div class="bg-yellow-50 border-2 border-yellow-400 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">üî• Anstehende & √ºberf√§llige Herausforderungen</h3>
                            <div class="space-y-3">
                                ${upcomingChallenges
                                  .map((challenge) => {
                                    const challengeDate =
                                      challenge.date?.seconds || 0;
                                    const date = new Date(challengeDate * 1000);
                                    const isOverdue =
                                      challengeDate < todayTimestamp;
                                    const dateStr =
                                      date.toLocaleDateString("de-DE");

                                    return `
                                        <div class="p-4 ${
                                          isOverdue
                                            ? "bg-red-100 border-red-500"
                                            : "bg-white border-yellow-500"
                                        } border-l-4 rounded-lg">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="font-bold text-gray-800">
                                                        ${getPlayerName(
                                                          challenge.challengerId
                                                        )} vs ${getPlayerName(
                                      challenge.challengedId
                                    )}
                                                    </div>
                                                    <div class="text-sm ${
                                                      isOverdue
                                                        ? "text-red-600 font-semibold"
                                                        : "text-gray-600"
                                                    }">
                                                        ${dateStr} ${
                                      isOverdue ? "‚ö†Ô∏è √úBERF√ÑLLIG" : "üìÖ Heute"
                                    }
                                                    </div>
                                                </div>
                                                <button onclick="enterResultFromChallenge('${
                                                  challenge.id
                                                }')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                                    Ergebnis eintragen
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                  })
                                  .join("")}
                            </div>
                        </div>
                    `
                        : ""
                    }
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div onclick="navigateTo('singles')" class="bg-white rounded-xl shadow-lg p-8 cursor-pointer hover:shadow-xl transition-shadow">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="text-yellow-500">${
                                  icons.trophy
                                }</div>
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">Einzel-Turnier</h3>
                            </div>
                            <p class="text-gray-600">Gruppenphasen mit anschlie√üendem K.O.-System</p>
                        </div>
                        
                        <div onclick="navigateTo('doubles')" class="bg-white rounded-xl shadow-lg p-8 cursor-pointer hover:shadow-xl transition-shadow">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="text-blue-500">${
                                  icons.pyramid
                                }</div>
                                <h3 class="text-xl md:text-2xl font-bold text-gray-800">Doppel-Pyramide</h3>
                            </div>
                            <p class="text-gray-600">Herausforderungs-System mit dynamischer Rangfolge</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Letzte Ergebnisse</h3>
                        ${
                          recentMatches.length === 0
                            ? `
                            <p class="text-gray-500 text-center py-8">Noch keine Spiele eingetragen</p>
                        `
                            : `
                            <div class="space-y-3">
                                ${recentMatches
                                  .map((match) => {
                                    const scoreText = match.sets
                                      ? match.sets
                                          .map(
                                            (s) =>
                                              `${s.p1 || s.t1}:${s.p2 || s.t2}`
                                          )
                                          .join(", ")
                                      : "Ausstehend";
                                    return `
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <span class="font-medium">${getPlayerName(
                                              match.player1Id ||
                                                match.team1?.player1Id
                                            )} vs ${getPlayerName(
                                      match.player2Id || match.team2?.player1Id
                                    )}</span>
                                            <span class="text-indigo-600 font-bold">${scoreText}</span>
                                        </div>
                                    `;
                                  })
                                  .join("")}
                            </div>
                        `
                        }
                    </div>
                </div>
            `;
      }

      function SinglesPage() {
        const group1 = calculateStandings(1);
        const group2 = calculateStandings(2);

        // Automatisch K.O.-Phase anzeigen wenn aktiv
        if (state.knockoutPhaseActive && state.singlesView === "group") {
          state.singlesView = "knockout";
        }

        return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Einzel-Turnier</h2>
                        
                        ${
                          state.knockoutPhaseActive
                            ? `
                            <div class="mb-6 flex flex-col sm:flex-row gap-2">
                                <button onclick="showFrozenGroupPhase()" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-all ${
                                  state.singlesView === "group"
                                    ? "bg-indigo-600 text-white"
                                    : "bg-gray-200 text-gray-600 hover:bg-gray-300"
                                }">
                                    Gruppenphase (eingefroren)
                                </button>
                                <button onclick="setSinglesView('knockout')" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-all ${
                                  state.singlesView === "knockout"
                                    ? "bg-indigo-600 text-white"
                                    : "bg-gray-200 text-gray-600 hover:bg-gray-300"
                                }">
                                    K.O.-Phase
                                </button>
                            </div>
                        `
                            : ""
                        }
                        
                        ${
                          state.singlesView === "group"
                            ? `
                            ${
                              state.knockoutPhaseActive && state.frozenStandings
                                ? `
                                <div class="mb-4 p-3 bg-blue-50 border border-blue-300 rounded-lg">
                                    <p class="text-sm text-blue-800">üìã Diese Tabelle zeigt den Stand zum Zeitpunkt des Starts der K.O.-Phase.</p>
                                </div>
                                <div class="grid md:grid-cols-2 gap-6 mb-6">
                                    ${FrozenGroupTable(
                                      1,
                                      state.frozenStandings.group1
                                    )}
                                    ${FrozenGroupTable(
                                      2,
                                      state.frozenStandings.group2
                                    )}
                                </div>
                            `
                                : `
                                <div class="grid md:grid-cols-2 gap-6 mb-6">
                                    ${GroupTable(1, group1)}
                                    ${GroupTable(2, group2)}
                                </div>
                                
                                ${state.user ? SinglesMatchEntry() : ""}
                            `
                            }
                        `
                            : `
                            ${KnockoutBracketView()}
                        `
                        }
                    </div>
                </div>
            `;
      }

      // NEU: Eingefrorene Gruppenphase Tabelle
      function FrozenGroupTable(groupNum, standings) {
        return `
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Gruppe ${groupNum} <span class="text-sm font-normal text-gray-500">(Endstand)</span></h3>
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-gray-600 border-b">
                                <th class="pb-2">Platz</th>
                                <th class="pb-2">Spieler</th>
                                <th class="pb-2">Sp</th>
                                <th class="pb-2">Pkt</th>
                                <th class="pb-2">S√§tze</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${
                              !standings || standings.length === 0
                                ? `
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-gray-500">Keine Spieler in Gruppe ${groupNum}</td>
                                </tr>
                            `
                                : standings
                                    .map(
                                      (player, idx) => `
                                <tr class="border-b border-gray-200">
                                    <td class="py-2 font-bold">${idx + 1}</td>
                                    <td class="py-2">${player.name}</td>
                                    <td class="py-2">${player.matches}</td>
                                    <td class="py-2 font-semibold">${
                                      player.points
                                    }</td>
                                    <td class="py-2">${player.setsWon}:${
                                        player.setsLost
                                      }</td>
                                </tr>
                            `
                                    )
                                    .join("")
                            }
                        </tbody>
                    </table>
                </div>
            `;
      }

      function KnockoutBracketView() {
        const config = state.knockoutConfig || {};

        // Helper function to resolve position to player ID (nutzt eingefrorene Tabelle)
        const getPositionPlayerId = (position) => {
          if (!position) return null;
          const [group, place] = position.split("p");
          const groupNum = group === "g1" ? 1 : 2;
          const placeNum = parseInt(place);

          // Nutze eingefrorene Tabelle wenn vorhanden
          if (state.frozenStandings) {
            const standings =
              groupNum === 1
                ? state.frozenStandings.group1
                : state.frozenStandings.group2;
            const player = standings[placeNum - 1];
            return player ? player.id : null;
          }

          // Fallback auf aktuelle Tabelle
          const standings = calculateStandings(groupNum);
          const player = standings[placeNum - 1];
          return player ? player.id : null;
        };

        // Gibt das K.O.-Spiel f√ºr eine bestimmte Runde und Spielnummer zur√ºck
        const getKnockoutMatch = (round, matchNum) => {
          return state.knockoutMatches.find(
            (m) => m.round === round && m.matchNum === matchNum
          );
        };

        // Gibt den Gewinner eines K.O.-Spiels zur√ºck
        const getKnockoutMatchWinner = (round, matchNum) => {
          const match = getKnockoutMatch(round, matchNum);
          if (!match || !match.sets) return null;

          let p1Sets = 0,
            p2Sets = 0;
          match.sets.forEach((set) => {
            if (set.p1 > set.p2) p1Sets++;
            else p2Sets++;
          });

          return p1Sets > p2Sets ? match.player1Id : match.player2Id;
        };

        // Gibt den Verlierer eines K.O.-Spiels zur√ºck
        const getKnockoutMatchLoser = (round, matchNum) => {
          const match = getKnockoutMatch(round, matchNum);
          if (!match || !match.sets) return null;

          let p1Sets = 0,
            p2Sets = 0;
          match.sets.forEach((set) => {
            if (set.p1 > set.p2) p1Sets++;
            else p2Sets++;
          });

          return p1Sets > p2Sets ? match.player2Id : match.player1Id;
        };

        // Pr√ºft ob ein K.O.-Spiel stornierbar ist
        const canCancelKnockoutMatch = (round, matchNum) => {
          const match = getKnockoutMatch(round, matchNum);
          if (!match || !match.sets) return false;

          // Finale und Platz 3 k√∂nnen immer storniert werden
          if (round === "final" || round === "thirdPlace") return true;

          // F√ºr Viertelfinale: Pr√ºfe ob zugeh√∂riges Halbfinale schon gespielt wurde
          if (round === "quarter") {
            const sfNum = matchNum <= 2 ? 1 : 2;
            const sfMatch = getKnockoutMatch("semi", sfNum);
            if (sfMatch && sfMatch.sets) return false;
            return true;
          }

          // F√ºr Halbfinale: Pr√ºfe ob Finale oder Platz 3 schon gespielt wurde
          if (round === "semi") {
            const finalMatch = getKnockoutMatch("final", 1);
            const thirdMatch = getKnockoutMatch("thirdPlace", 1);
            if (
              (finalMatch && finalMatch.sets) ||
              (thirdMatch && thirdMatch.sets)
            )
              return false;
            return true;
          }

          return true;
        };

        // Ermittelt die Spieler f√ºr ein K.O.-Spiel
        const getKnockoutMatchPlayers = (round, matchNum) => {
          if (round === "quarter") {
            const p1Pos = config[`qf_${matchNum}_p1`];
            const p2Pos = config[`qf_${matchNum}_p2`];
            return {
              player1Id: getPositionPlayerId(p1Pos),
              player2Id: getPositionPlayerId(p2Pos),
              player1Name: getPositionPlayerId(p1Pos)
                ? getPlayerName(getPositionPlayerId(p1Pos))
                : "TBD",
              player2Name: getPositionPlayerId(p2Pos)
                ? getPlayerName(getPositionPlayerId(p2Pos))
                : "TBD",
            };
          }

          if (round === "semi") {
            if (matchNum === 1) {
              const p1 = getKnockoutMatchWinner("quarter", 1);
              const p2 = getKnockoutMatchWinner("quarter", 2);
              return {
                player1Id: p1,
                player2Id: p2,
                player1Name: p1 ? getPlayerName(p1) : "Gewinner VF1",
                player2Name: p2 ? getPlayerName(p2) : "Gewinner VF2",
              };
            } else {
              const p1 = getKnockoutMatchWinner("quarter", 3);
              const p2 = getKnockoutMatchWinner("quarter", 4);
              return {
                player1Id: p1,
                player2Id: p2,
                player1Name: p1 ? getPlayerName(p1) : "Gewinner VF3",
                player2Name: p2 ? getPlayerName(p2) : "Gewinner VF4",
              };
            }
          }

          if (round === "thirdPlace") {
            const p1 = getKnockoutMatchLoser("semi", 1);
            const p2 = getKnockoutMatchLoser("semi", 2);
            return {
              player1Id: p1,
              player2Id: p2,
              player1Name: p1 ? getPlayerName(p1) : "Verlierer HF1",
              player2Name: p2 ? getPlayerName(p2) : "Verlierer HF2",
            };
          }

          if (round === "final") {
            const p1 = getKnockoutMatchWinner("semi", 1);
            const p2 = getKnockoutMatchWinner("semi", 2);
            return {
              player1Id: p1,
              player2Id: p2,
              player1Name: p1 ? getPlayerName(p1) : "Gewinner HF1",
              player2Name: p2 ? getPlayerName(p2) : "Gewinner HF2",
            };
          }

          return {
            player1Id: null,
            player2Id: null,
            player1Name: "TBD",
            player2Name: "TBD",
          };
        };

        // Rendert ein einzelnes K.O.-Match-Card
        const renderKnockoutMatchCard = (
          round,
          matchNum,
          title,
          borderColor = "blue"
        ) => {
          const match = getKnockoutMatch(round, matchNum);
          const players = getKnockoutMatchPlayers(round, matchNum);
          const isPlayed = match && match.sets;
          const canPlay = players.player1Id && players.player2Id;
          const canCancel = canCancelKnockoutMatch(round, matchNum);

          let resultText = "";
          let winnerId = null;
          if (isPlayed) {
            let p1Sets = 0,
              p2Sets = 0;
            match.sets.forEach((set) => {
              if (set.p1 > set.p2) p1Sets++;
              else p2Sets++;
            });
            resultText =
              p1Sets +
              ":" +
              p2Sets +
              " (" +
              match.sets.map((s) => s.p1 + ":" + s.p2).join(", ") +
              ")";
            winnerId = p1Sets > p2Sets ? match.player1Id : match.player2Id;
          }

          return (
            '<div class="bg-white p-4 rounded-lg border-2 border-' +
            borderColor +
            '-400">' +
            '<div class="text-sm font-medium text-gray-700 mb-3">' +
            title +
            "</div>" +
            '<div class="space-y-2">' +
            '<div class="p-2 ' +
            (isPlayed && winnerId === players.player1Id
              ? "bg-green-100 font-bold"
              : "bg-gray-50") +
            ' rounded text-sm flex justify-between items-center">' +
            "<span>" +
            players.player1Name +
            "</span>" +
            (isPlayed && winnerId === players.player1Id
              ? '<span class="text-green-600">‚úì</span>'
              : "") +
            "</div>" +
            '<div class="text-center text-xs text-gray-500">vs</div>' +
            '<div class="p-2 ' +
            (isPlayed && winnerId === players.player2Id
              ? "bg-green-100 font-bold"
              : "bg-gray-50") +
            ' rounded text-sm flex justify-between items-center">' +
            "<span>" +
            players.player2Name +
            "</span>" +
            (isPlayed && winnerId === players.player2Id
              ? '<span class="text-green-600">‚úì</span>'
              : "") +
            "</div>" +
            "</div>" +
            (isPlayed
              ? '<div class="mt-3 text-center">' +
                '<div class="text-sm font-semibold text-indigo-600">' +
                resultText +
                "</div>" +
                (state.user && canCancel
                  ? "<button onclick=\"cancelKnockoutMatch('" +
                    round +
                    "', " +
                    matchNum +
                    ')" class="mt-2 px-3 py-1 text-xs bg-red-100 text-red-600 rounded hover:bg-red-200">Stornieren</button>'
                  : "") +
                "</div>"
              : state.user && canPlay
              ? "<button onclick=\"openKnockoutMatchEntry('" +
                round +
                "', " +
                matchNum +
                ')" class="mt-3 w-full px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700">Ergebnis eintragen</button>'
              : state.user
              ? '<div class="mt-3 text-center text-xs text-gray-400">Warte auf vorherige Spiele</div>'
              : "") +
            "</div>"
          );
        };

        return `
                <div class="space-y-6">
                    <!-- Ergebnis-Eingabe Modal -->
                    ${state.knockoutEntryMatch ? KnockoutMatchEntryModal() : ""}
                    
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-lg border-2 border-yellow-400">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">üèÜ K.O.-Phase</h3>
                        
                        <div class="mb-6">
                            <h4 class="font-bold text-gray-700 mb-3">Viertelfinale</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                ${renderKnockoutMatchCard("quarter", 1, "VF 1")}
                                ${renderKnockoutMatchCard("quarter", 2, "VF 2")}
                                ${renderKnockoutMatchCard("quarter", 3, "VF 3")}
                                ${renderKnockoutMatchCard("quarter", 4, "VF 4")}
                            </div>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-bold text-gray-700 mb-3">Halbfinale</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${renderKnockoutMatchCard(
                                  "semi",
                                  1,
                                  "Halbfinale 1"
                                )}
                                ${renderKnockoutMatchCard(
                                  "semi",
                                  2,
                                  "Halbfinale 2"
                                )}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${renderKnockoutMatchCard(
                              "thirdPlace",
                              1,
                              "ü•â Spiel um Platz 3",
                              "amber"
                            )}
                            ${renderKnockoutMatchCard(
                              "final",
                              1,
                              "ü•á Finale",
                              "yellow"
                            )}
                        </div>
                    </div>
                </div>
            `;
      }

      // NEU: Modal f√ºr K.O.-Spiel Ergebnis-Eingabe
      function KnockoutMatchEntryModal() {
        const { round, matchNum } = state.knockoutEntryMatch;
        const config = state.knockoutConfig || {};

        // Helper functions (duplicated here for modal context)
        const getPositionPlayerId = (position) => {
          if (!position) return null;
          const [group, place] = position.split("p");
          const groupNum = group === "g1" ? 1 : 2;
          const placeNum = parseInt(place);
          if (state.frozenStandings) {
            const standings =
              groupNum === 1
                ? state.frozenStandings.group1
                : state.frozenStandings.group2;
            const player = standings[placeNum - 1];
            return player ? player.id : null;
          }
          const standings = calculateStandings(groupNum);
          const player = standings[placeNum - 1];
          return player ? player.id : null;
        };

        const getKnockoutMatch = (r, m) =>
          state.knockoutMatches.find(
            (match) => match.round === r && match.matchNum === m
          );

        const getKnockoutMatchWinner = (r, m) => {
          const match = getKnockoutMatch(r, m);
          if (!match || !match.sets) return null;
          let p1Sets = 0,
            p2Sets = 0;
          match.sets.forEach((set) => {
            if (set.p1 > set.p2) p1Sets++;
            else p2Sets++;
          });
          return p1Sets > p2Sets ? match.player1Id : match.player2Id;
        };

        const getKnockoutMatchLoser = (r, m) => {
          const match = getKnockoutMatch(r, m);
          if (!match || !match.sets) return null;
          let p1Sets = 0,
            p2Sets = 0;
          match.sets.forEach((set) => {
            if (set.p1 > set.p2) p1Sets++;
            else p2Sets++;
          });
          return p1Sets > p2Sets ? match.player2Id : match.player1Id;
        };

        let player1Id, player2Id, player1Name, player2Name;

        if (round === "quarter") {
          const p1Pos = config["qf_" + matchNum + "_p1"];
          const p2Pos = config["qf_" + matchNum + "_p2"];
          player1Id = getPositionPlayerId(p1Pos);
          player2Id = getPositionPlayerId(p2Pos);
          player1Name = player1Id ? getPlayerName(player1Id) : "TBD";
          player2Name = player2Id ? getPlayerName(player2Id) : "TBD";
        } else if (round === "semi") {
          if (matchNum === 1) {
            player1Id = getKnockoutMatchWinner("quarter", 1);
            player2Id = getKnockoutMatchWinner("quarter", 2);
            player1Name = player1Id ? getPlayerName(player1Id) : "Gewinner VF1";
            player2Name = player2Id ? getPlayerName(player2Id) : "Gewinner VF2";
          } else {
            player1Id = getKnockoutMatchWinner("quarter", 3);
            player2Id = getKnockoutMatchWinner("quarter", 4);
            player1Name = player1Id ? getPlayerName(player1Id) : "Gewinner VF3";
            player2Name = player2Id ? getPlayerName(player2Id) : "Gewinner VF4";
          }
        } else if (round === "thirdPlace") {
          player1Id = getKnockoutMatchLoser("semi", 1);
          player2Id = getKnockoutMatchLoser("semi", 2);
          player1Name = player1Id ? getPlayerName(player1Id) : "Verlierer HF1";
          player2Name = player2Id ? getPlayerName(player2Id) : "Verlierer HF2";
        } else if (round === "final") {
          player1Id = getKnockoutMatchWinner("semi", 1);
          player2Id = getKnockoutMatchWinner("semi", 2);
          player1Name = player1Id ? getPlayerName(player1Id) : "Gewinner HF1";
          player2Name = player2Id ? getPlayerName(player2Id) : "Gewinner HF2";
        }

        const roundNames = {
          quarter: "Viertelfinale " + matchNum,
          semi: "Halbfinale " + matchNum,
          thirdPlace: "Spiel um Platz 3",
          final: "Finale",
        };

        return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold text-gray-800">${
                roundNames[round]
              }</h3>
              <button onclick="closeKnockoutMatchEntry()" class="p-2 hover:bg-gray-100 rounded-full">
                ${icons.x}
              </button>
            </div>
            
            <div class="mb-4 p-4 bg-indigo-50 rounded-lg">
              <div class="text-center">
                <span class="font-bold text-lg">${player1Name}</span>
                <span class="mx-3 text-gray-500">vs</span>
                <span class="font-bold text-lg">${player2Name}</span>
              </div>
            </div>
            
            <input type="hidden" id="koPlayer1Id" value="${player1Id || ""}">
            <input type="hidden" id="koPlayer2Id" value="${player2Id || ""}">
            <input type="hidden" id="koRound" value="${round}">
            <input type="hidden" id="koMatchNum" value="${matchNum}">
            
            <div class="space-y-4 mb-6">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - ${player1Name}</label>
                  <input type="number" id="koSet1P1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - ${player2Name}</label>
                  <input type="number" id="koSet1P2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - ${player1Name}</label>
                  <input type="number" id="koSet2P1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - ${player2Name}</label>
                  <input type="number" id="koSet2P2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - ${player1Name} (optional)</label>
                  <input type="number" id="koSet3P1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - ${player2Name} (optional)</label>
                  <input type="number" id="koSet3P2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                </div>
              </div>
            </div>
            
            <div class="flex gap-3">
              <button onclick="closeKnockoutMatchEntry()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                Abbrechen
              </button>
              <button onclick="saveKnockoutMatch()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Speichern
              </button>
            </div>
          </div>
        </div>
      `;
      }

      function GroupTable(groupNum, standings) {
        return `
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Gruppe ${groupNum}</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-gray-600 border-b">
                                <th class="pb-2">Platz</th>
                                <th class="pb-2">Spieler</th>
                                <th class="pb-2">Sp</th>
                                <th class="pb-2">Pkt</th>
                                <th class="pb-2">S√§tze</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${
                              standings.length === 0
                                ? `
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-gray-500">Keine Spieler in Gruppe ${groupNum}</td>
                                </tr>
                            `
                                : standings
                                    .map(
                                      (player, idx) => `
                                <tr class="border-b border-gray-200">
                                    <td class="py-2 font-bold">${idx + 1}</td>
                                    <td class="py-2">${player.name}</td>
                                    <td class="py-2">${player.matches}</td>
                                    <td class="py-2 font-semibold">${
                                      player.points
                                    }</td>
                                    <td class="py-2">${player.setsWon}:${
                                        player.setsLost
                                      }</td>
                                </tr>
                            `
                                    )
                                    .join("")
                            }
                        </tbody>
                    </table>
                </div>
            `;
      }

      function SinglesMatchEntry() {
        const group1Players = getGroupPlayers(1);
        const group2Players = getGroupPlayers(2);
        const allSinglesPlayers = [...group1Players, ...group2Players];

        return `
                <div class="p-4 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-3">Neues Einzel-Spiel eintragen</h4>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <select id="singlesP1" class="px-3 py-2 border rounded-lg">
                            <option value="">Spieler 1 w√§hlen</option>
                            ${allSinglesPlayers
                              .map(
                                (p) =>
                                  `<option value="${p.id}">${p.name}</option>`
                              )
                              .join("")}
                        </select>
                        <select id="singlesP2" class="px-3 py-2 border rounded-lg">
                            <option value="">Spieler 2 w√§hlen</option>
                            ${allSinglesPlayers
                              .map(
                                (p) =>
                                  `<option value="${p.id}">${p.name}</option>`
                              )
                              .join("")}
                        </select>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Spieler 1</label>
                                <input type="number" id="set1P1" min="0" max="30" 
                                    oninput="updateMatchEntry('set1P1', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Spieler 2</label>
                                <input type="number" id="set1P2" min="0" max="30"
                                    oninput="updateMatchEntry('set1P2', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Spieler 1</label>
                                <input type="number" id="set2P1" min="0" max="30"
                                    oninput="updateMatchEntry('set2P1', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Spieler 2</label>
                                <input type="number" id="set2P2" min="0" max="30"
                                    oninput="updateMatchEntry('set2P2', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Spieler 1</label>
                                <input type="number" id="set3P1" min="0" max="30"
                                    oninput="updateMatchEntry('set3P1', this.value)"
                                    ${
                                      state.matchEntry.set3Disabled
                                        ? "disabled"
                                        : ""
                                    }
                                    class="w-full px-3 py-2 border rounded-lg ${
                                      state.matchEntry.set3Disabled
                                        ? "bg-gray-200"
                                        : ""
                                    }">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Spieler 2</label>
                                <input type="number" id="set3P2" min="0" max="30"
                                    oninput="updateMatchEntry('set3P2', this.value)"
                                    ${
                                      state.matchEntry.set3Disabled
                                        ? "disabled"
                                        : ""
                                    }
                                    class="w-full px-3 py-2 border rounded-lg ${
                                      state.matchEntry.set3Disabled
                                        ? "bg-gray-200"
                                        : ""
                                    }">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="addSinglesMatch()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Spiel eintragen
                    </button>
                </div>
            `;
      }

      function DoublesPage() {
        const levels = state.pyramid.levels || [];

        return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Doppel-Pyramide</h2>
                        
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold mb-3">Aktuelle Rangfolge</h3>
                            ${
                              levels.length === 0
                                ? `
                                <div class="text-center py-12 bg-gray-50 rounded-lg">
                                    <div class="text-blue-500 mb-4">${
                                      icons.pyramid
                                    }</div>
                                    <p class="text-gray-600">Pyramide noch nicht initialisiert</p>
                                    ${
                                      state.user
                                        ? `
                                        <button onclick="initPyramid()" class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                            Pyramide initialisieren
                                        </button>
                                    `
                                        : ""
                                    }
                                </div>
                            `
                                : `
                                <div class="space-y-4">
                                    ${levels
                                      .map(
                                        (level, levelIdx) => `
                                        <div class="flex flex-wrap justify-center items-center gap-2 sm:gap-4">
                                            ${level
                                              .map(
                                                (playerId, posIdx) => `
                                                <div class="relative">
                                                    <div class="bg-gradient-to-r from-yellow-100 to-orange-100 border-2 border-yellow-500 rounded-lg px-3 py-2 sm:px-4 sm:py-3 text-center shadow-md min-w-[100px] sm:min-w-[120px]">
                                                        
                                                        <div class="font-bold text-gray-800 text-sm sm:text-base break-words">${getPlayerName(
                                                          playerId
                                                        )}</div>
                                                    </div>
                                                </div>
                                            `
                                              )
                                              .join("")}
                                        </div>
                                    `
                                      )
                                      .join("")}
                                </div>
                            `
                            }
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold mb-3">Anstehende Herausforderungen</h3>
                            ${
                              state.challenges.length === 0
                                ? `
                                <div class="text-center py-8 bg-gray-50 rounded-lg">
                                    <p class="text-gray-500">Keine anstehenden Herausforderungen</p>
                                </div>
                            `
                                : `
                                <div class="space-y-3">
                                    ${state.challenges
                                      .map(
                                        (challenge) => `
                                        <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                                                <span class="font-medium">${getPlayerName(
                                                  challenge.challengerId
                                                )} fordert ${getPlayerName(
                                          challenge.challengedId
                                        )} heraus</span>
                                                <span class="text-sm text-gray-500">Offen</span>
                                            </div>
                                        </div>
                                    `
                                      )
                                      .join("")}
                                </div>
                            `
                            }
                        </div>
                        
                        ${
                          state.user && levels.length > 0
                            ? DoublesMatchEntry()
                            : ""
                        }
                    </div>
                </div>
            `;
      }

      function DoublesMatchEntry() {
        const doublesPlayers = state.players.filter((p) => p.doublesPool);

        // Check if we have prefilled data
        const prefill = state.prefilledDoubles || {};

        return `
                <div class="p-4 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-3">Doppel-Spiel eintragen</h4>
                    
                    ${
                      prefill.challengerId
                        ? `
                        <div class="mb-3 p-2 bg-blue-100 border border-blue-400 rounded text-sm text-blue-800">
                            üìå Herausforderung: ${getPlayerName(
                              prefill.challengerId
                            )} vs ${getPlayerName(prefill.challengedId)}
                        </div>
                    `
                        : ""
                    }
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Team 1</label>
                            <select id="doublesT1P1" class="w-full px-3 py-2 border rounded-lg mb-2">
                                <option value="">Spieler 1</option>
                                ${doublesPlayers
                                  .map(
                                    (p) =>
                                      `<option value="${p.id}" ${
                                        prefill.challengerId === p.id
                                          ? "selected"
                                          : ""
                                      }>${p.name}</option>`
                                  )
                                  .join("")}
                            </select>
                            <select id="doublesT1P2" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Spieler 2</option>
                                ${doublesPlayers
                                  .map(
                                    (p) =>
                                      `<option value="${p.id}">${p.name}</option>`
                                  )
                                  .join("")}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Team 2</label>
                            <select id="doublesT2P1" class="w-full px-3 py-2 border rounded-lg mb-2">
                                <option value="">Spieler 1</option>
                                ${doublesPlayers
                                  .map(
                                    (p) =>
                                      `<option value="${p.id}" ${
                                        prefill.challengedId === p.id
                                          ? "selected"
                                          : ""
                                      }>${p.name}</option>`
                                  )
                                  .join("")}
                            </select>
                            <select id="doublesT2P2" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Spieler 2</option>
                                ${doublesPlayers
                                  .map(
                                    (p) =>
                                      `<option value="${p.id}">${p.name}</option>`
                                  )
                                  .join("")}
                            </select>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Team 1</label>
                                <input type="number" id="doublesSet1T1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Team 2</label>
                                <input type="number" id="doublesSet1T2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Team 1</label>
                                <input type="number" id="doublesSet2T1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Team 2</label>
                                <input type="number" id="doublesSet2T2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Team 1</label>
                                <input type="number" id="doublesSet3T1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Team 2</label>
                                <input type="number" id="doublesSet3T2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="addDoublesMatch()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Doppel-Spiel eintragen
                    </button>
                </div>
            `;
      }

      function ChallengesPage() {
        const doublesPlayers = state.players.filter((p) => p.doublesPool);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toISOString().split("T")[0];

        return `
                <div class="space-y-6">
                    ${
                      state.user
                        ? `
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Neue Herausforderung eintragen</h2>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <select id="newChallenger" class="px-3 py-2 border rounded-lg">
                                    <option value="">Herausforderer</option>
                                    ${doublesPlayers
                                      .map(
                                        (p) =>
                                          `<option value="${p.id}">${p.name}</option>`
                                      )
                                      .join("")}
                                </select>
                                <select id="newChallenged" class="px-3 py-2 border rounded-lg">
                                    <option value="">Herausgeforderter</option>
                                    ${doublesPlayers
                                      .map(
                                        (p) =>
                                          `<option value="${p.id}">${p.name}</option>`
                                      )
                                      .join("")}
                                </select>
                                <input type="date" id="challengeDate" min="${todayStr}" class="px-3 py-2 border rounded-lg">
                                <button onclick="addChallenge()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    Herausforderung eintragen
                                </button>
                            </div>
                        </div>
                    `
                        : ""
                    }
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Alle Herausforderungen</h2>
                        ${
                          state.challenges.length === 0
                            ? `
                            <p class="text-center py-8 text-gray-500">Noch keine Herausforderungen eingetragen</p>
                        `
                            : `
                            <div class="space-y-3">
                                ${state.challenges
                                  .map((challenge) => {
                                    const challengeDate =
                                      challenge.date?.seconds || 0;
                                    const date = new Date(challengeDate * 1000);
                                    const todayTimestamp =
                                      today.getTime() / 1000;
                                    const isOverdue =
                                      challengeDate < todayTimestamp &&
                                      challenge.status !== "completed";
                                    const isToday =
                                      challengeDate >= todayTimestamp &&
                                      challengeDate < todayTimestamp + 86400;
                                    const dateStr =
                                      date.toLocaleDateString("de-DE");

                                    let statusColor = "bg-gray-50";
                                    let statusText = "Geplant";
                                    if (challenge.status === "completed") {
                                      statusColor =
                                        "bg-green-50 border-green-500";
                                      statusText = "‚úÖ Erledigt";
                                    } else if (isOverdue) {
                                      statusColor = "bg-red-50 border-red-500";
                                      statusText = "‚ö†Ô∏è √úBERF√ÑLLIG";
                                    } else if (isToday) {
                                      statusColor =
                                        "bg-yellow-50 border-yellow-500";
                                      statusText = "üìÖ Heute";
                                    }

                                    return `
                                        <div class="p-4 ${statusColor} border-l-4 rounded-lg">
                                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                                                <div class="flex-1">
                                                    <div class="font-bold text-gray-800">
                                                        ${getPlayerName(
                                                          challenge.challengerId
                                                        )} vs ${getPlayerName(
                                      challenge.challengedId
                                    )}
                                                    </div>
                                                    <div class="text-sm text-gray-600 mt-1">
                                                        ${dateStr} ‚Ä¢ ${statusText}
                                                    </div>
                                                </div>
                                                ${
                                                  state.user &&
                                                  challenge.status !==
                                                    "completed"
                                                    ? `
                                                    <div class="flex flex-col sm:flex-row w-full sm:w-auto space-y-2 sm:space-y-0 sm:space-x-2">
                                                        <button onclick="enterResultFromChallenge('${challenge.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm whitespace-nowrap">
                                                            Ergebnis eintragen
                                                        </button>
                                                        <button onclick="markChallengeCompleted('${challenge.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm whitespace-nowrap">
                                                            Als erledigt markieren
                                                        </button>
                                                    </div>
                                                `
                                                    : ""
                                                }
                                            </div>
                                        </div>
                                    `;
                                  })
                                  .join("")}
                            </div>
                        `
                        }
                    </div>
                </div>
            `;
      }

      function PlayersPage() {
        return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Alle Spieler</h2>
                    
                    ${
                      state.players.length === 0
                        ? `
                        <p class="text-center py-8 text-gray-500">Noch keine Spieler registriert</p>
                    `
                        : `
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${state.players
                              .map(
                                (player) => `
                                <div onclick="viewPlayerProfile('${
                                  player.id
                                }')" class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors">
                                    <h3 class="text-lg font-bold text-gray-800">${
                                      player.name
                                    }</h3>
                                    <div class="text-sm text-gray-600 mt-2 space-y-1">
                                        ${
                                          player.singlesGroup
                                            ? `<div>Einzel: Gruppe ${player.singlesGroup}</div>`
                                            : ""
                                        }
                                        ${
                                          player.doublesPool
                                            ? `<div>Doppel: Pool ${player.doublesPool}</div>`
                                            : ""
                                        }
                                        ${
                                          !player.singlesGroup &&
                                          !player.doublesPool
                                            ? '<div class="text-gray-400">Kein Turnier</div>'
                                            : ""
                                        }
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    `
                    }
                </div>
            `;
      }

      function PlayerProfilePage(playerId) {
        const player = state.players.find((p) => p.id === playerId);
        if (!player) return "<div>Spieler nicht gefunden</div>";

        const singlesMatches = state.singlesMatches.filter(
          (m) => m.player1Id === playerId || m.player2Id === playerId
        );

        const doublesMatches = state.doublesMatches.filter(
          (m) =>
            m.team1.player1Id === playerId ||
            m.team1.player2Id === playerId ||
            m.team2.player1Id === playerId ||
            m.team2.player2Id === playerId
        );

        let singlesWins = 0,
          singlesLosses = 0;
        singlesMatches.forEach((match) => {
          if (!match.sets || match.sets.length < 2) return;
          let p1Sets = 0,
            p2Sets = 0;
          match.sets.forEach((set) => {
            if (set.p1 > set.p2) p1Sets++;
            else p2Sets++;
          });

          const isPlayer1 = match.player1Id === playerId;
          if (
            (isPlayer1 && p1Sets > p2Sets) ||
            (!isPlayer1 && p2Sets > p1Sets)
          ) {
            singlesWins++;
          } else {
            singlesLosses++;
          }
        });

        return `
                <div class="space-y-6">
                    <button onclick="navigateTo('players')" class="text-indigo-600 hover:text-indigo-800 flex items-center space-x-2">
                        <span>‚Üê Zur√ºck zu allen Spielern</span>
                    </button>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">${
                          player.name
                        }</h2>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <div class="text-sm text-gray-600 mb-1">Einzel-Bilanz</div>
                                <div class="text-xl md:text-2xl font-bold text-gray-800">${singlesWins}:${singlesLosses}</div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="text-sm text-gray-600 mb-1">Doppel-Spiele</div>
                                <div class="text-xl md:text-2xl font-bold text-gray-800">${
                                  doublesMatches.length
                                }</div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            ${
                              singlesMatches.length > 0
                                ? `
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">Einzel-Spiele</h3>
                                    <div class="space-y-2">
                                        ${singlesMatches
                                          .map((match) => {
                                            const isPlayer1 =
                                              match.player1Id === playerId;
                                            const opponent = isPlayer1
                                              ? getPlayerName(match.player2Id)
                                              : getPlayerName(match.player1Id);
                                            const scoreText = match.sets
                                              ? match.sets
                                                  .map((s) => `${s.p1}:${s.p2}`)
                                                  .join(", ")
                                              : "Ausstehend";

                                            let result = "";
                                            if (
                                              match.sets &&
                                              match.sets.length >= 2
                                            ) {
                                              let p1Sets = 0,
                                                p2Sets = 0;
                                              match.sets.forEach((set) => {
                                                if (set.p1 > set.p2) p1Sets++;
                                                else p2Sets++;
                                              });
                                              const won =
                                                (isPlayer1 &&
                                                  p1Sets > p2Sets) ||
                                                (!isPlayer1 && p2Sets > p1Sets);
                                              result = won
                                                ? "Sieg"
                                                : "Niederlage";
                                            }

                                            return `
                                                <div class="p-3 ${
                                                  result === "Sieg"
                                                    ? "bg-green-50"
                                                    : result === "Niederlage"
                                                    ? "bg-red-50"
                                                    : "bg-gray-50"
                                                } rounded-lg">
                                                    <div class="flex justify-between items-center">
                                                        <span class="font-medium">vs ${opponent}</span>
                                                        <div class="text-right">
                                                            <span class="font-bold ${
                                                              result === "Sieg"
                                                                ? "text-green-600"
                                                                : result ===
                                                                  "Niederlage"
                                                                ? "text-red-600"
                                                                : "text-gray-600"
                                                            }">${
                                              result || "Offen"
                                            }</span>
                                                            <div class="text-sm text-gray-600">${scoreText}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                          })
                                          .join("")}
                                    </div>
                                </div>
                            `
                                : ""
                            }

                            ${
                              doublesMatches.length > 0
                                ? `
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">Doppel-Spiele</h3>
                                    <div class="space-y-2">
                                        ${doublesMatches
                                          .map((match) => {
                                            const isTeam1 =
                                              match.team1.player1Id ===
                                                playerId ||
                                              match.team1.player2Id ===
                                                playerId;
                                            const partner = isTeam1
                                              ? getPlayerName(
                                                  match.team1.player1Id ===
                                                    playerId
                                                    ? match.team1.player2Id
                                                    : match.team1.player1Id
                                                )
                                              : getPlayerName(
                                                  match.team2.player1Id ===
                                                    playerId
                                                    ? match.team2.player2Id
                                                    : match.team2.player1Id
                                                );
                                            const opponents = isTeam1
                                              ? `${getPlayerName(
                                                  match.team2.player1Id
                                                )} / ${getPlayerName(
                                                  match.team2.player2Id
                                                )}`
                                              : `${getPlayerName(
                                                  match.team1.player1Id
                                                )} / ${getPlayerName(
                                                  match.team1.player2Id
                                                )}`;
                                            const scoreText = match.sets
                                              ? match.sets
                                                  .map((s) => `${s.t1}:${s.t2}`)
                                                  .join(", ")
                                              : "Ausstehend";

                                            let result = "";
                                            if (
                                              match.sets &&
                                              match.sets.length >= 2
                                            ) {
                                              let t1Sets = 0,
                                                t2Sets = 0;
                                              match.sets.forEach((set) => {
                                                if (set.t1 > set.t2) t1Sets++;
                                                else t2Sets++;
                                              });
                                              const won =
                                                (isTeam1 && t1Sets > t2Sets) ||
                                                (!isTeam1 && t2Sets > t1Sets);
                                              result = won
                                                ? "Sieg"
                                                : "Niederlage";
                                            }

                                            return `
                                                <div class="p-3 ${
                                                  result === "Sieg"
                                                    ? "bg-green-50"
                                                    : result === "Niederlage"
                                                    ? "bg-red-50"
                                                    : "bg-gray-50"
                                                } rounded-lg">
                                                    <div class="flex justify-between items-center">
                                                        <div>
                                                            <div class="font-medium">mit ${partner}</div>
                                                            <div class="text-sm text-gray-600">vs ${opponents}</div>
                                                        </div>
                                                        <div class="text-right">
                                                            <span class="font-bold ${
                                                              result === "Sieg"
                                                                ? "text-green-600"
                                                                : result ===
                                                                  "Niederlage"
                                                                ? "text-red-600"
                                                                : "text-gray-600"
                                                            }">${
                                              result || "Offen"
                                            }</span>
                                                            <div class="text-sm text-gray-600">${scoreText}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                          })
                                          .join("")}
                                    </div>
                                </div>
                            `
                                : ""
                            }

                            ${
                              singlesMatches.length === 0 &&
                              doublesMatches.length === 0
                                ? `
                                <div class="text-center py-8 text-gray-500">
                                    Noch keine Spiele f√ºr diesen Spieler
                                </div>
                            `
                                : ""
                            }
                        </div>
                    </div>
                </div>
            `;
      }

      function AdminPage() {
        if (!state.user) {
          return `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-lg p-8">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">Admin Login</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="admin@verein.de">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Passwort</label>
                                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Passwort">
                                </div>
                                <div id="loginError" class="text-red-500 text-sm hidden"></div>
                                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                    Anmelden
                                </button>
                            </div>
                        </div>
                    </div>
                `;
        }

        return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Admin-Bereich</h2>
                        
                        <!-- Tab Navigation -->
                        <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-200 pb-2">
                            <button onclick="setAdminTab('players')" class="px-4 py-2 text-left sm:text-center rounded-t ${
                              state.adminTab === "players"
                                ? "bg-indigo-600 text-white font-semibold"
                                : "text-gray-600 hover:bg-gray-100"
                            }">
                                Spieler
                            </button>
                            <button onclick="setAdminTab('singles')" class="px-4 py-2 text-left sm:text-center rounded-t ${
                              state.adminTab === "singles"
                                ? "bg-indigo-600 text-white font-semibold"
                                : "text-gray-600 hover:bg-gray-100"
                            }">
                                Einzel-Ergebnisse
                            </button>
                            <button onclick="setAdminTab('singlesTable')" class="px-4 py-2 text-left sm:text-center rounded-t ${
                              state.adminTab === "singlesTable"
                                ? "bg-indigo-600 text-white font-semibold"
                                : "text-gray-600 hover:bg-gray-100"
                            }">
                                Einzel-Tabelle
                            </button>
                            <button onclick="setAdminTab('doubles')" class="px-4 py-2 text-left sm:text-center rounded-t ${
                              state.adminTab === "doubles"
                                ? "bg-indigo-600 text-white font-semibold"
                                : "text-gray-600 hover:bg-gray-100"
                            }">
                                Doppel-Ergebnisse
                            </button>
                            <button onclick="setAdminTab('doublesRanking')" class="px-4 py-2 text-left sm:text-center rounded-t ${
                              state.adminTab === "doublesRanking"
                                ? "bg-indigo-600 text-white font-semibold"
                                : "text-gray-600 hover:bg-gray-100"
                            }">
                                Doppel-Rangfolge
                            </button>
                        </div>

                        ${state.adminTab === "players" ? AdminPlayersTab() : ""}
                        ${state.adminTab === "singles" ? AdminSinglesTab() : ""}
                        ${
                          state.adminTab === "singlesTable"
                            ? AdminSinglesTableTab()
                            : ""
                        }
                        ${state.adminTab === "doubles" ? AdminDoublesTab() : ""}
                        ${
                          state.adminTab === "doublesRanking"
                            ? AdminDoublesRankingTab()
                            : ""
                        }
                    </div>
                </div>
            `;
      }

      function AdminPlayersTab() {
        return `
                <div>
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">Neuen Spieler hinzuf√ºgen</h4>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                            <input type="text" id="playerName" placeholder="Name" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                            <button onclick="addPlayer()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2">
                                ${icons.plus}
                                <span>Hinzuf√ºgen</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        ${state.players
                          .map(
                            (player) => `
                            ${
                              state.editingPlayer === player.id
                                ? `
                                <div class="p-4 bg-blue-50 border-2 border-blue-500 rounded-lg">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                            <input type="text" id="editName_${
                                              player.id
                                            }" value="${
                                    player.name
                                  }" class="w-full px-3 py-2 border rounded-lg">
                                        </div>
                                        
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Einzel-Gruppe</label>
                                                <select id="editSingles_${
                                                  player.id
                                                }" class="w-full px-3 py-2 border rounded-lg">
                                                    <option value="">Nicht dabei</option>
                                                    <option value="1" ${
                                                      player.singlesGroup === 1
                                                        ? "selected"
                                                        : ""
                                                    }>Gruppe 1</option>
                                                    <option value="2" ${
                                                      player.singlesGroup === 2
                                                        ? "selected"
                                                        : ""
                                                    }>Gruppe 2</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Doppel-Pool</label>
                                                <select id="editDoubles_${
                                                  player.id
                                                }" class="w-full px-3 py-2 border rounded-lg">
                                                    <option value="">Nicht dabei</option>
                                                    <option value="A" ${
                                                      player.doublesPool === "A"
                                                        ? "selected"
                                                        : ""
                                                    }>Pool A (stark)</option>
                                                    <option value="B" ${
                                                      player.doublesPool === "B"
                                                        ? "selected"
                                                        : ""
                                                    }>Pool B (schwach)</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="flex space-x-2">
                                            <button onclick="savePlayer('${
                                              player.id
                                            }')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center space-x-2">
                                                ${icons.save}
                                                <span>Speichern</span>
                                            </button>
                                            <button onclick="cancelEdit()" class="flex-1 px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 flex items-center justify-center space-x-2">
                                                ${icons.x}
                                                <span>Abbrechen</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `
                                : `
                                <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:border-gray-300">
                                    <div>
                                        <span class="font-medium text-gray-800 break-words">${
                                          player.name
                                        }</span>
                                        <div class="text-sm text-gray-500 mt-1">
                                            ${
                                              player.singlesGroup
                                                ? `Einzel: Gruppe ${player.singlesGroup}`
                                                : ""
                                            }
                                            ${
                                              player.singlesGroup &&
                                              player.doublesPool
                                                ? " ‚Ä¢ "
                                                : ""
                                            }
                                            ${
                                              player.doublesPool
                                                ? `Doppel: Pool ${player.doublesPool}`
                                                : ""
                                            }
                                            ${
                                              !player.singlesGroup &&
                                              !player.doublesPool
                                                ? "Nimmt nicht teil"
                                                : ""
                                            }
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="editPlayer('${
                                          player.id
                                        }')" class="p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors">
                                            ${icons.edit}
                                        </button>
                                        <button onclick="deletePlayer('${
                                          player.id
                                        }')" class="p-2 text-red-600 hover:bg-red-50 rounded transition-colors">
                                            ${icons.trash}
                                        </button>
                                    </div>
                                </div>
                            `
                            }
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;
      }

      function AdminSinglesTab() {
        const searchQuery = state.singlesSearchQuery || "";

        const filteredMatches = state.singlesMatches.filter((match) => {
          if (!searchQuery) return true;
          const p1Name = getPlayerName(match.player1Id).toLowerCase();
          const p2Name = getPlayerName(match.player2Id).toLowerCase();
          const query = searchQuery.toLowerCase();
          return p1Name.includes(query) || p2Name.includes(query);
        });

        return `
                <div>
                    <div class="mb-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <input 
                            type="text" 
                            id="singlesSearchInput" 
                            placeholder="Nach Spielername suchen..." 
                            value="${searchQuery}"
                            onkeyup="updateSinglesSearch(this.value)"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                        >
                        <button onclick="exportSinglesMatches()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center space-x-2 whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span>Excel Export</span>
                        </button>
                    </div>

                    <div class="space-y-3">
                        ${
                          filteredMatches.length === 0
                            ? `
                            <p class="text-gray-500 text-center py-8">Keine Spiele gefunden</p>
                        `
                            : filteredMatches
                                .map((match) => {
                                  const p1Name = getPlayerName(match.player1Id);
                                  const p2Name = getPlayerName(match.player2Id);
                                  const scoreText = match.sets
                                    ? match.sets
                                        .map((s) => `${s.p1}:${s.p2}`)
                                        .join(", ")
                                    : "Ausstehend";

                                  let p1Sets = 0,
                                    p2Sets = 0;
                                  if (match.sets) {
                                    match.sets.forEach((set) => {
                                      if (set.p1 > set.p2) p1Sets++;
                                      else p2Sets++;
                                    });
                                  }

                                  const dateStr = match.date
                                    ? new Date(
                                        match.date.toDate()
                                      ).toLocaleDateString("de-DE")
                                    : "";

                                  return `
                            <div class="p-4 bg-white border border-gray-200 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-800">
                                            ${p1Name} <span class="text-indigo-600 font-bold">${p1Sets}</span> : <span class="text-indigo-600 font-bold">${p2Sets}</span> ${p2Name}
                                        </div>
                                        <div class="text-sm text-gray-500 mt-1">${scoreText}</div>
                                        ${
                                          dateStr
                                            ? `<div class="text-xs text-gray-400 mt-1">${dateStr}</div>`
                                            : ""
                                        }
                                    </div>
                                </div>
                            </div>
                          `;
                                })
                                .join("")
                        }
                    </div>
                </div>
            `;
      }

      function AdminDoublesTab() {
        const searchQuery = state.doublesSearchQuery || "";

        const filteredMatches = state.doublesMatches.filter((match) => {
          if (!searchQuery) return true;
          const t1p1Name = getPlayerName(match.team1.player1Id).toLowerCase();
          const t1p2Name = getPlayerName(match.team1.player2Id).toLowerCase();
          const t2p1Name = getPlayerName(match.team2.player1Id).toLowerCase();
          const t2p2Name = getPlayerName(match.team2.player2Id).toLowerCase();
          const query = searchQuery.toLowerCase();
          return (
            t1p1Name.includes(query) ||
            t1p2Name.includes(query) ||
            t2p1Name.includes(query) ||
            t2p2Name.includes(query)
          );
        });

        return `
                <div>
                    <div class="mb-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <input 
                            type="text" 
                            id="doublesSearchInput" 
                            placeholder="Nach Spielername suchen..." 
                            value="${searchQuery}"
                            onkeyup="updateDoublesSearch(this.value)"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                        >
                        <button onclick="exportDoublesMatches()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center space-x-2 whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span>Excel Export</span>
                        </button>
                    </div>

                    <div class="space-y-3">
                        ${
                          filteredMatches.length === 0
                            ? `
                            <p class="text-gray-500 text-center py-8">Keine Spiele gefunden</p>
                        `
                            : filteredMatches
                                .map((match) => {
                                  const t1p1Name = getPlayerName(
                                    match.team1.player1Id
                                  );
                                  const t1p2Name = getPlayerName(
                                    match.team1.player2Id
                                  );
                                  const t2p1Name = getPlayerName(
                                    match.team2.player1Id
                                  );
                                  const t2p2Name = getPlayerName(
                                    match.team2.player2Id
                                  );
                                  const scoreText = match.sets
                                    ? match.sets
                                        .map((s) => `${s.t1}:${s.t2}`)
                                        .join(", ")
                                    : "Ausstehend";

                                  let t1Sets = 0,
                                    t2Sets = 0;
                                  if (match.sets) {
                                    match.sets.forEach((set) => {
                                      if (set.t1 > set.t2) t1Sets++;
                                      else t2Sets++;
                                    });
                                  }

                                  const dateStr = match.date
                                    ? new Date(
                                        match.date.toDate()
                                      ).toLocaleDateString("de-DE")
                                    : "";

                                  return `
                            <div class="p-4 bg-white border border-gray-200 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-800">
                                            ${t1p1Name} / ${t1p2Name} <span class="text-indigo-600 font-bold">${t1Sets}</span> : <span class="text-indigo-600 font-bold">${t2Sets}</span> ${t2p1Name} / ${t2p2Name}
                                        </div>
                                        <div class="text-sm text-gray-500 mt-1">${scoreText}</div>
                                        ${
                                          dateStr
                                            ? `<div class="text-xs text-gray-400 mt-1">${dateStr}</div>`
                                            : ""
                                        }
                                    </div>
                                </div>
                            </div>
                          `;
                                })
                                .join("")
                        }
                    </div>
                </div>
            `;
      }

      function AdminSinglesTableTab() {
        const group1 = calculateStandings(1);
        const group2 = calculateStandings(2);

        const positions = [
          { value: "g1p1", label: "1. Platz Gruppe 1" },
          { value: "g1p2", label: "2. Platz Gruppe 1" },
          { value: "g1p3", label: "3. Platz Gruppe 1" },
          { value: "g1p4", label: "4. Platz Gruppe 1" },
          { value: "g2p1", label: "1. Platz Gruppe 2" },
          { value: "g2p2", label: "2. Platz Gruppe 2" },
          { value: "g2p3", label: "3. Platz Gruppe 2" },
          { value: "g2p4", label: "4. Platz Gruppe 2" },
        ];

        const config = state.knockoutConfig || {};

        return `
                <div>
                    <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <h3 class="text-xl font-bold text-gray-800">Einzel-Tabellen</h3>
                        <button onclick="exportSinglesTables()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span>Tabellen exportieren</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        ${GroupTable(1, group1)}
                        ${GroupTable(2, group2)}
                    </div>

                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">K.O.-Phase konfigurieren</h3>
                        
                        ${
                          !state.knockoutPhaseActive
                            ? `
                            <div class="mb-4 p-4 bg-blue-50 border border-blue-300 rounded-lg">
                                <p class="text-sm text-blue-800 mb-3">Konfiguriere die Paarungen nach Platzierung. Nach dem Start der K.O.-Phase k√∂nnen die Ergebnisse eingetragen werden.</p>
                                <button onclick="activateKnockoutPhase()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
                                    K.O.-Phase starten
                                </button>
                            </div>
                        `
                            : `
                            <div class="mb-4 p-4 bg-green-50 border border-green-300 rounded-lg">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                    <p class="text-sm text-green-800">‚úÖ K.O.-Phase ist aktiv. Die Gruppenphase-Tabellen wurden eingefroren.</p>
                                    <button onclick="deactivateKnockoutPhase()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-semibold">
                                        K.O.-Phase deaktivieren
                                    </button>
                                </div>
                            </div>
                        `
                        }

                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">Viertelfinale (4 Spiele)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${[1, 2, 3, 4]
                                      .map(
                                        (i) => `
                                        <div class="bg-white p-4 rounded-lg border">
                                            <label class="block text-sm font-medium mb-2">Viertelfinale ${i}</label>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                                <select id="qf_${i}_p1" class="px-3 py-2 border rounded-lg text-sm">
                                                    <option value="">Position w√§hlen</option>
                                                    ${positions
                                                      .map(
                                                        (pos) => `
                                                        <option value="${
                                                          pos.value
                                                        }" ${
                                                          config[
                                                            "qf_" + i + "_p1"
                                                          ] === pos.value
                                                            ? "selected"
                                                            : ""
                                                        }>${pos.label}</option>
                                                    `
                                                      )
                                                      .join("")}
                                                </select>
                                                <select id="qf_${i}_p2" class="px-3 py-2 border rounded-lg text-sm">
                                                    <option value="">Position w√§hlen</option>
                                                    ${positions
                                                      .map(
                                                        (pos) => `
                                                        <option value="${
                                                          pos.value
                                                        }" ${
                                                          config[
                                                            "qf_" + i + "_p2"
                                                          ] === pos.value
                                                            ? "selected"
                                                            : ""
                                                        }>${pos.label}</option>
                                                    `
                                                      )
                                                      .join("")}
                                                </select>
                                            </div>
                                        </div>
                                    `
                                      )
                                      .join("")}
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">Halbfinale (2 Spiele)</h4>
                                <p class="text-xs text-gray-500 mb-2">Gewinner aus Viertelfinale</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-lg border">
                                        <label class="block text-sm font-medium mb-2">Halbfinale 1</label>
                                        <div class="text-sm text-gray-600">Gewinner VF1 vs Gewinner VF2</div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border">
                                        <label class="block text-sm font-medium mb-2">Halbfinale 2</label>
                                        <div class="text-sm text-gray-600">Gewinner VF3 vs Gewinner VF4</div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">Finale & Platz 3</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-4 rounded-lg border border-amber-400">
                                        <label class="block text-sm font-medium mb-2">ü•â Spiel um Platz 3</label>
                                        <div class="text-sm text-gray-600">Verlierer HF1 vs Verlierer HF2</div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border border-yellow-400">
                                        <label class="block text-sm font-medium mb-2">ü•á Finale</label>
                                        <div class="text-sm text-gray-600">Gewinner HF1 vs Gewinner HF2</div>
                                    </div>
                                </div>
                            </div>

                            <button onclick="saveKnockoutConfig()" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                                Paarungen speichern
                            </button>
                        </div>
                    </div>
                </div>
            `;
      }

      function AdminDoublesRankingTab() {
        const levels = state.pyramid.levels || [];
        const flatPositions = [];
        levels.forEach((level) => {
          level.forEach((playerId) => {
            flatPositions.push(playerId);
          });
        });

        return `
                <div>
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Doppel-Rangfolge bearbeiten</h3>
                        <p class="text-sm text-gray-600 mb-4">Nutze die Pfeile, um die Spieler in die gew√ºnschte Reihenfolge zu bringen.</p>
                    </div>

                    ${
                      flatPositions.length === 0
                        ? `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Pyramide noch nicht initialisiert</p>
                            <button onclick="initPyramid()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                Pyramide initialisieren
                            </button>
                        </div>
                    `
                        : `
                        <div class="space-y-3 mb-6" id="rankingList">
                            ${flatPositions
                              .map(
                                (playerId, idx) => `
                                <div class="flex items-center justify-between p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-300" data-player-id="${playerId}" data-position="${idx}">
                                    <div class="flex items-center space-x-4">
                                        <span class="font-bold text-gray-500 w-8">#${
                                          idx + 1
                                        }</span>
                                        <span class="font-medium text-gray-800">${getPlayerName(
                                          playerId
                                        )}</span>
                                    </div>
                                    <div class="flex space-x-2">
                                        ${
                                          idx > 0
                                            ? `
                                            <button onclick="movePlayerUp(${idx})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded transition-colors">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                                </svg>
                                            </button>
                                        `
                                            : ""
                                        }
                                        ${
                                          idx < flatPositions.length - 1
                                            ? `
                                            <button onclick="movePlayerDown(${idx})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded transition-colors">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                </svg>
                                            </button>
                                        `
                                            : ""
                                        }
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>

                        <button onclick="saveDoublesRanking()" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                            Rangfolge speichern
                        </button>
                    `
                    }
                </div>
            `;
      }

      // ============================================
      // EVENT HANDLERS
      // ============================================
      function navigateTo(page) {
        state.currentPage = page;
        state.selectedPlayerId = null;
        state.prefilledDoubles = null; // Clear prefilled data when navigating
        state.mobileMenuOpen = false; // Close mobile menu when navigating
        render();
      }

      function viewPlayerProfile(playerId) {
        state.selectedPlayerId = playerId;
        state.currentPage = "playerProfile";
        render();
      }

      function enterResultFromChallenge(challengeId) {
        const challenge = state.challenges.find((c) => c.id === challengeId);
        if (challenge) {
          state.prefilledDoubles = {
            challengerId: challenge.challengerId,
            challengedId: challenge.challengedId,
            challengeId: challengeId,
          };
          state.currentPage = "doubles";
          render();
        }
      }

      async function markChallengeCompleted(challengeId) {
        if (confirm("Herausforderung als erledigt markieren?")) {
          await db.collection("challenges").doc(challengeId).update({
            status: "completed",
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
          alert("Herausforderung als erledigt markiert");
        }
      }

      async function handleLogin() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const errorDiv = document.getElementById("loginError");

        try {
          await auth.signInWithEmailAndPassword(email, password);
          state.currentPage = "admin";
        } catch (error) {
          errorDiv.textContent = "Login fehlgeschlagen: " + error.message;
          errorDiv.classList.remove("hidden");
        }
      }

      async function handleLogout() {
        await auth.signOut();
        state.currentPage = "home";
      }

      function setAdminTab(tab) {
        state.adminTab = tab;
        render();
      }

      function toggleMobileMenu() {
        state.mobileMenuOpen = !state.mobileMenuOpen;
        render();
      }

      function updateSinglesSearch(query) {
        state.singlesSearchQuery = query;
        // Speichere den Fokus
        const activeElement = document.activeElement;
        const isSearchInput =
          activeElement && activeElement.id === "singlesSearchInput";
        render();
        // Stelle den Fokus wieder her
        if (isSearchInput) {
          setTimeout(() => {
            const input = document.getElementById("singlesSearchInput");
            if (input) {
              input.focus();
              input.setSelectionRange(query.length, query.length);
            }
          }, 0);
        }
      }

      function updateDoublesSearch(query) {
        state.doublesSearchQuery = query;
        // Speichere den Fokus
        const activeElement = document.activeElement;
        const isSearchInput =
          activeElement && activeElement.id === "doublesSearchInput";
        render();
        // Stelle den Fokus wieder her
        if (isSearchInput) {
          setTimeout(() => {
            const input = document.getElementById("doublesSearchInput");
            if (input) {
              input.focus();
              input.setSelectionRange(query.length, query.length);
            }
          }, 0);
        }
      }

      function exportSinglesMatches() {
        const searchQuery = state.singlesSearchQuery || "";

        const filteredMatches = state.singlesMatches.filter((match) => {
          if (!searchQuery) return true;
          const p1Name = getPlayerName(match.player1Id).toLowerCase();
          const p2Name = getPlayerName(match.player2Id).toLowerCase();
          const query = searchQuery.toLowerCase();
          return p1Name.includes(query) || p2Name.includes(query);
        });

        if (filteredMatches.length === 0) {
          alert("Keine Spiele zum Exportieren gefunden");
          return;
        }

        const data = filteredMatches.map((match) => {
          const p1Name = getPlayerName(match.player1Id);
          const p2Name = getPlayerName(match.player2Id);

          let p1Sets = 0,
            p2Sets = 0;
          if (match.sets) {
            match.sets.forEach((set) => {
              if (set.p1 > set.p2) p1Sets++;
              else p2Sets++;
            });
          }

          const dateStr = match.date
            ? new Date(match.date.toDate()).toLocaleDateString("de-DE")
            : "";
          const sets = match.sets
            ? match.sets.map((s) => `${s.p1}:${s.p2}`).join(", ")
            : "";

          return {
            Datum: dateStr,
            "Spieler 1": p1Name,
            "Spieler 2": p2Name,
            Ergebnis: `${p1Sets}:${p2Sets}`,
            S√§tze: sets,
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Einzel-Ergebnisse");
        XLSX.writeFile(wb, "einzel-ergebnisse.xlsx");
      }

      function exportDoublesMatches() {
        const searchQuery = state.doublesSearchQuery || "";

        const filteredMatches = state.doublesMatches.filter((match) => {
          if (!searchQuery) return true;
          const t1p1Name = getPlayerName(match.team1.player1Id).toLowerCase();
          const t1p2Name = getPlayerName(match.team1.player2Id).toLowerCase();
          const t2p1Name = getPlayerName(match.team2.player1Id).toLowerCase();
          const t2p2Name = getPlayerName(match.team2.player2Id).toLowerCase();
          const query = searchQuery.toLowerCase();
          return (
            t1p1Name.includes(query) ||
            t1p2Name.includes(query) ||
            t2p1Name.includes(query) ||
            t2p2Name.includes(query)
          );
        });

        if (filteredMatches.length === 0) {
          alert("Keine Spiele zum Exportieren gefunden");
          return;
        }

        const data = filteredMatches.map((match) => {
          const t1p1Name = getPlayerName(match.team1.player1Id);
          const t1p2Name = getPlayerName(match.team1.player2Id);
          const t2p1Name = getPlayerName(match.team2.player1Id);
          const t2p2Name = getPlayerName(match.team2.player2Id);

          let t1Sets = 0,
            t2Sets = 0;
          if (match.sets) {
            match.sets.forEach((set) => {
              if (set.t1 > set.t2) t1Sets++;
              else t2Sets++;
            });
          }

          const dateStr = match.date
            ? new Date(match.date.toDate()).toLocaleDateString("de-DE")
            : "";
          const sets = match.sets
            ? match.sets.map((s) => `${s.t1}:${s.t2}`).join(", ")
            : "";

          return {
            Datum: dateStr,
            "Team 1 Spieler 1": t1p1Name,
            "Team 1 Spieler 2": t1p2Name,
            "Team 2 Spieler 1": t2p1Name,
            "Team 2 Spieler 2": t2p2Name,
            Ergebnis: `${t1Sets}:${t2Sets}`,
            S√§tze: sets,
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Doppel-Ergebnisse");
        XLSX.writeFile(wb, "doppel-ergebnisse.xlsx");
      }

      function exportSinglesTables() {
        const group1 = calculateStandings(1);
        const group2 = calculateStandings(2);

        const data1 = group1.map((player, idx) => ({
          Platz: idx + 1,
          Spieler: player.name,
          Spiele: player.matches,
          Punkte: player.points,
          S√§tze: `${player.setsWon}:${player.setsLost}`,
        }));

        const data2 = group2.map((player, idx) => ({
          Platz: idx + 1,
          Spieler: player.name,
          Spiele: player.matches,
          Punkte: player.points,
          S√§tze: `${player.setsWon}:${player.setsLost}`,
        }));

        const wb = XLSX.utils.book_new();
        const ws1 = XLSX.utils.json_to_sheet(data1);
        const ws2 = XLSX.utils.json_to_sheet(data2);
        XLSX.utils.book_append_sheet(wb, ws1, "Gruppe 1");
        XLSX.utils.book_append_sheet(wb, ws2, "Gruppe 2");
        XLSX.writeFile(wb, "einzel-tabellen.xlsx");
      }

      async function activateKnockoutPhase() {
        if (
          !confirm(
            "K.O.-Phase jetzt starten? Die aktuellen Gruppenphase-Tabellen werden eingefroren und k√∂nnen nicht mehr ge√§ndert werden."
          )
        ) {
          return;
        }

        // Aktuelle Tabellen einfrieren
        const group1 = calculateStandings(1);
        const group2 = calculateStandings(2);

        const frozenStandings = {
          group1: group1,
          group2: group2,
        };

        state.knockoutPhaseActive = true;
        state.frozenStandings = frozenStandings;

        // Save to Firebase
        await db.collection("settings").doc("knockout").set({
          active: true,
          frozenStandings: frozenStandings,
          activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        alert(
          "K.O.-Phase aktiviert! Die Gruppenphase-Tabellen wurden eingefroren."
        );
        render();
      }

      async function deactivateKnockoutPhase() {
        if (
          !confirm(
            "K.O.-Phase wirklich deaktivieren? Alle K.O.-Spiele-Ergebnisse bleiben erhalten, aber die eingefrorenen Tabellen werden verworfen."
          )
        ) {
          return;
        }

        state.knockoutPhaseActive = false;
        state.frozenStandings = null;
        state.singlesView = "group";

        // Save to Firebase
        await db.collection("settings").doc("knockout").set({
          active: false,
          frozenStandings: null,
          deactivatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        alert("K.O.-Phase deaktiviert.");
        render();
      }

      async function saveKnockoutConfig() {
        // Sammle alle Viertelfinale-Paarungen
        const config = {};
        for (let i = 1; i <= 4; i++) {
          const p1 = document.getElementById(`qf_${i}_p1`)?.value || "";
          const p2 = document.getElementById(`qf_${i}_p2`)?.value || "";
          if (p1) config[`qf_${i}_p1`] = p1;
          if (p2) config[`qf_${i}_p2`] = p2;
        }

        state.knockoutConfig = config;

        try {
          await db
            .collection("settings")
            .doc("knockoutConfig")
            .set({
              ...config,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

          alert("Paarungen erfolgreich gespeichert!");
        } catch (error) {
          console.log(db.collection("settings"));
          console.error("Fehler beim Speichern:", error);
          alert("Fehler beim Speichern: " + error.message);
        }
      }

      function movePlayerUp(index) {
        const levels = state.pyramid.levels || [];
        const flatPositions = [];
        levels.forEach((level) => {
          level.forEach((playerId) => {
            flatPositions.push(playerId);
          });
        });

        if (index > 0) {
          const temp = flatPositions[index];
          flatPositions[index] = flatPositions[index - 1];
          flatPositions[index - 1] = temp;

          // Update state
          state.pyramid.levels = rebuildPyramidLevels(flatPositions);
          render();
        }
      }

      function movePlayerDown(index) {
        const levels = state.pyramid.levels || [];
        const flatPositions = [];
        levels.forEach((level) => {
          level.forEach((playerId) => {
            flatPositions.push(playerId);
          });
        });

        if (index < flatPositions.length - 1) {
          const temp = flatPositions[index];
          flatPositions[index] = flatPositions[index + 1];
          flatPositions[index + 1] = temp;

          // Update state
          state.pyramid.levels = rebuildPyramidLevels(flatPositions);
          render();
        }
      }

      function rebuildPyramidLevels(flatPositions) {
        const levels = [];
        let idx = 0;
        let levelNum = 1;

        while (idx < flatPositions.length) {
          const levelPlayers = flatPositions.slice(idx, idx + levelNum);
          levels.push(levelPlayers);
          idx += levelNum;
          levelNum++;
        }

        return levels;
      }

      async function saveDoublesRanking() {
        const levels = state.pyramid.levels || [];

        const levelsObject = {};
        levels.forEach((level, idx) => {
          levelsObject[`level${idx + 1}`] = level;
        });

        await db
          .collection("pyramid")
          .doc("current")
          .set({
            ...levelsObject,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
          });

        alert("Rangfolge gespeichert!");
      }

      function setSinglesView(view) {
        state.singlesView = view;
        render();
      }

      // NEU: Zeigt eingefrorene Gruppenphase an (Button Klick wenn K.O. aktiv)
      function showFrozenGroupPhase() {
        state.singlesView = "group";
        render();
      }

      // NEU: √ñffnet das Modal f√ºr K.O.-Spiel Ergebnis-Eingabe
      function openKnockoutMatchEntry(round, matchNum) {
        state.knockoutEntryMatch = { round, matchNum };
        // Reset match entry state
        state.matchEntry = {
          set1P1: "",
          set1P2: "",
          set2P1: "",
          set2P2: "",
          set3P1: "",
          set3P2: "",
          set3Disabled: false,
        };
        render();
      }

      // NEU: Schlie√üt das Modal
      function closeKnockoutMatchEntry() {
        state.knockoutEntryMatch = null;
        render();
      }

      // NEU: Speichert ein K.O.-Spiel Ergebnis
      async function saveKnockoutMatch() {
        const player1Id = document.getElementById("koPlayer1Id").value;
        const player2Id = document.getElementById("koPlayer2Id").value;
        const round = document.getElementById("koRound").value;
        const matchNum = parseInt(document.getElementById("koMatchNum").value);

        const set1P1 = parseInt(document.getElementById("koSet1P1").value);
        const set1P2 = parseInt(document.getElementById("koSet1P2").value);
        const set2P1 = parseInt(document.getElementById("koSet2P1").value);
        const set2P2 = parseInt(document.getElementById("koSet2P2").value);
        const set3P1 = parseInt(document.getElementById("koSet3P1").value);
        const set3P2 = parseInt(document.getElementById("koSet3P2").value);

        if (!player1Id || !player2Id) {
          alert("Spieler nicht verf√ºgbar");
          return;
        }

        if (!validateSet(set1P1, set1P2) || !validateSet(set2P1, set2P2)) {
          alert("Ung√ºltige Satz-Ergebnisse in Satz 1 oder 2");
          return;
        }

        const sets = [
          { p1: set1P1, p2: set1P2 },
          { p1: set2P1, p2: set2P2 },
        ];

        const set1Winner = set1P1 > set1P2 ? "p1" : "p2";
        const set2Winner = set2P1 > set2P2 ? "p1" : "p2";

        // Check if set 3 is needed
        if (set1Winner !== set2Winner) {
          if (!isNaN(set3P1) && !isNaN(set3P2)) {
            if (!validateSet(set3P1, set3P2)) {
              alert("Ung√ºltiges Satz-Ergebnis in Satz 3");
              return;
            }
            sets.push({ p1: set3P1, p2: set3P2 });
          } else {
            alert("Dritter Satz ist erforderlich (Spielstand 1:1)");
            return;
          }
        }

        try {
          // Pr√ºfe ob bereits ein Ergebnis f√ºr dieses Spiel existiert
          const existingMatch = state.knockoutMatches.find(
            (m) => m.round === round && m.matchNum === matchNum
          );

          if (existingMatch) {
            // Update existing match
            await db
              .collection("knockoutMatches")
              .doc(existingMatch.id)
              .update({
                player1Id,
                player2Id,
                sets,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
          } else {
            // Create new match
            await db.collection("knockoutMatches").add({
              round,
              matchNum,
              player1Id,
              player2Id,
              sets,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          }

          state.knockoutEntryMatch = null;
          alert("K.O.-Spiel erfolgreich eingetragen!");
          render();
        } catch (error) {
          console.error("Fehler beim Speichern:", error);
          alert("Fehler beim Speichern: " + error.message);
        }
      }

      // NEU: Storniert ein K.O.-Spiel Ergebnis
      async function cancelKnockoutMatch(round, matchNum) {
        // Pr√ºfe ob nachfolgende Spiele existieren
        const canCancel = checkCanCancelMatch(round, matchNum);

        if (!canCancel) {
          alert(
            "Dieses Spiel kann nicht mehr storniert werden, da bereits ein nachfolgendes Spiel stattgefunden hat."
          );
          return;
        }

        if (
          !confirm(
            "Spielergebnis wirklich stornieren? Der Gewinner wird aus der n√§chsten Runde entfernt."
          )
        ) {
          return;
        }

        try {
          const match = state.knockoutMatches.find(
            (m) => m.round === round && m.matchNum === matchNum
          );
          if (match) {
            await db.collection("knockoutMatches").doc(match.id).delete();
            alert("Spielergebnis storniert.");
            render();
          }
        } catch (error) {
          console.error("Fehler beim Stornieren:", error);
          alert("Fehler beim Stornieren: " + error.message);
        }
      }

      // Helper: Pr√ºft ob ein K.O.-Spiel storniert werden kann
      function checkCanCancelMatch(round, matchNum) {
        const getKnockoutMatch = (r, m) =>
          state.knockoutMatches.find(
            (match) => match.round === r && match.matchNum === m
          );

        // Finale und Platz 3 k√∂nnen immer storniert werden
        if (round === "final" || round === "thirdPlace") return true;

        // F√ºr Viertelfinale: Pr√ºfe ob zugeh√∂riges Halbfinale schon gespielt wurde
        if (round === "quarter") {
          const sfNum = matchNum <= 2 ? 1 : 2;
          const sfMatch = getKnockoutMatch("semi", sfNum);
          if (sfMatch && sfMatch.sets) return false;
          return true;
        }

        // F√ºr Halbfinale: Pr√ºfe ob Finale oder Platz 3 schon gespielt wurde
        if (round === "semi") {
          const finalMatch = getKnockoutMatch("final", 1);
          const thirdMatch = getKnockoutMatch("thirdPlace", 1);
          if (
            (finalMatch && finalMatch.sets) ||
            (thirdMatch && thirdMatch.sets)
          )
            return false;
          return true;
        }

        return true;
      }

      async function addPlayer() {
        const name = document.getElementById("playerName").value.trim();

        if (name) {
          await db.collection("players").add({
            name,
            singlesGroup: null,
            doublesPool: null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          document.getElementById("playerName").value = "";
        }
      }

      function editPlayer(playerId) {
        state.editingPlayer = playerId;
        render();
      }

      function cancelEdit() {
        state.editingPlayer = null;
        render();
      }

      async function savePlayer(playerId) {
        const name = document
          .getElementById(`editName_${playerId}`)
          .value.trim();
        const singlesGroup = document.getElementById(
          `editSingles_${playerId}`
        ).value;
        const doublesPool = document.getElementById(
          `editDoubles_${playerId}`
        ).value;

        if (name) {
          const oldPlayer = state.players.find((p) => p.id === playerId);
          const oldDoublesPool = oldPlayer ? oldPlayer.doublesPool : null;

          await db
            .collection("players")
            .doc(playerId)
            .update({
              name,
              singlesGroup: singlesGroup ? parseInt(singlesGroup) : null,
              doublesPool: doublesPool || null,
            });

          state.editingPlayer = null;

          // If player was added to doubles pool, reload pyramid to add them
          if (!oldDoublesPool && doublesPool) {
            setTimeout(() => {
              loadPyramid();
            }, 500);
          }

          render();
        }
      }

      async function deletePlayer(playerId) {
        if (confirm("Spieler wirklich l√∂schen?")) {
          await db.collection("players").doc(playerId).delete();
        }
      }

      async function addSinglesMatch() {
        const p1 = document.getElementById("singlesP1").value;
        const p2 = document.getElementById("singlesP2").value;

        const set1P1 = parseInt(document.getElementById("set1P1").value);
        const set1P2 = parseInt(document.getElementById("set1P2").value);
        const set2P1 = parseInt(document.getElementById("set2P1").value);
        const set2P2 = parseInt(document.getElementById("set2P2").value);
        const set3P1 = parseInt(document.getElementById("set3P1").value);
        const set3P2 = parseInt(document.getElementById("set3P2").value);

        if (!p1 || !p2 || p1 === p2) {
          alert("Bitte zwei verschiedene Spieler ausw√§hlen");
          return;
        }

        if (!validateSet(set1P1, set1P2) || !validateSet(set2P1, set2P2)) {
          alert("Ung√ºltige Satz-Ergebnisse in Satz 1 oder 2");
          return;
        }

        const sets = [
          { p1: set1P1, p2: set1P2 },
          { p1: set2P1, p2: set2P2 },
        ];

        const set1Winner = set1P1 > set1P2 ? "p1" : "p2";
        const set2Winner = set2P1 > set2P2 ? "p1" : "p2";

        // Check if set 3 is needed
        if (set1Winner !== set2Winner) {
          if (!isNaN(set3P1) && !isNaN(set3P2)) {
            if (!validateSet(set3P1, set3P2)) {
              alert("Ung√ºltiges Satz-Ergebnis in Satz 3");
              return;
            }
            sets.push({ p1: set3P1, p2: set3P2 });
          } else {
            alert("Dritter Satz ist erforderlich (Spielstand 1:1)");
            return;
          }
        } else if (!isNaN(set3P1) || !isNaN(set3P2)) {
          alert("Dritter Satz nicht erlaubt (Spielstand bereits 2:0)");
          return;
        }

        await db.collection("singlesMatches").add({
          player1Id: p1,
          player2Id: p2,
          sets,
          date: firebase.firestore.FieldValue.serverTimestamp(),
        });

        // Reset form
        document.getElementById("singlesP1").value = "";
        document.getElementById("singlesP2").value = "";
        document.getElementById("set1P1").value = "";
        document.getElementById("set1P2").value = "";
        document.getElementById("set2P1").value = "";
        document.getElementById("set2P2").value = "";
        document.getElementById("set3P1").value = "";
        document.getElementById("set3P2").value = "";

        state.matchEntry = {
          set1P1: "",
          set1P2: "",
          set2P1: "",
          set2P2: "",
          set3P1: "",
          set3P2: "",
          set3Disabled: false,
        };

        alert("Spiel erfolgreich eingetragen!");
        render();
      }

      async function addDoublesMatch() {
        const t1p1 = document.getElementById("doublesT1P1").value;
        const t1p2 = document.getElementById("doublesT1P2").value;
        const t2p1 = document.getElementById("doublesT2P1").value;
        const t2p2 = document.getElementById("doublesT2P2").value;

        const set1T1 = parseInt(document.getElementById("doublesSet1T1").value);
        const set1T2 = parseInt(document.getElementById("doublesSet1T2").value);
        const set2T1 = parseInt(document.getElementById("doublesSet2T1").value);
        const set2T2 = parseInt(document.getElementById("doublesSet2T2").value);
        const set3T1 = parseInt(document.getElementById("doublesSet3T1").value);
        const set3T2 = parseInt(document.getElementById("doublesSet3T2").value);

        if (!t1p1 || !t1p2 || !t2p1 || !t2p2) {
          alert("Bitte alle 4 Spieler ausw√§hlen");
          return;
        }

        if (!validateSet(set1T1, set1T2) || !validateSet(set2T1, set2T2)) {
          alert("Ung√ºltige Satz-Ergebnisse");
          return;
        }

        const sets = [
          { t1: set1T1, t2: set1T2 },
          { t1: set2T1, t2: set2T2 },
        ];

        const set1Winner = set1T1 > set1T2 ? "t1" : "t2";
        const set2Winner = set2T1 > set2T2 ? "t1" : "t2";

        if (set1Winner !== set2Winner) {
          if (!isNaN(set3T1) && !isNaN(set3T2)) {
            if (!validateSet(set3T1, set3T2)) {
              alert("Ung√ºltiges Satz-Ergebnis in Satz 3");
              return;
            }
            sets.push({ t1: set3T1, t2: set3T2 });
          } else {
            alert("Dritter Satz ist erforderlich");
            return;
          }
        }

        await db.collection("doublesMatches").add({
          team1: { player1Id: t1p1, player2Id: t1p2 },
          team2: { player1Id: t2p1, player2Id: t2p2 },
          sets,
          date: firebase.firestore.FieldValue.serverTimestamp(),
        });

        // EVERY doubles match updates the pyramid
        let t1Sets = 0,
          t2Sets = 0;
        sets.forEach((set) => {
          if (set.t1 > set.t2) t1Sets++;
          else t2Sets++;
        });

        const winnerId = t1Sets > t2Sets ? t1p1 : t2p1;
        const loserId = t1Sets > t2Sets ? t2p1 : t1p1;

        await updatePyramidAfterChallenge(winnerId, loserId);

        // If this was from a challenge, mark it as completed
        if (state.prefilledDoubles && state.prefilledDoubles.challengeId) {
          await db
            .collection("challenges")
            .doc(state.prefilledDoubles.challengeId)
            .update({
              status: "completed",
              completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
        }

        // Clear prefilled data
        state.prefilledDoubles = null;

        // Reload pyramid after update (with delay to ensure Firestore has written)
        setTimeout(() => {
          loadPyramid();
        }, 1000);

        alert("Doppel-Spiel erfolgreich eingetragen!");
        render();
      }

      async function updatePyramidAfterChallenge(winnerId, loserId) {
        const pyramidDoc = await db.collection("pyramid").doc("current").get();
        if (!pyramidDoc.exists) {
          console.log("Pyramid doc does not exist");
          return;
        }

        const pyramidData = pyramidDoc.data();
        const levels = pyramidLevelsToArray(pyramidData);

        // Flatten to get positions
        let flatPositions = [];
        levels.forEach((level) => {
          level.forEach((playerId) => {
            flatPositions.push(playerId);
          });
        });

        const winnerPos = flatPositions.indexOf(winnerId);
        const loserPos = flatPositions.indexOf(loserId);

        if (winnerPos === -1 || loserPos === -1) {
          return;
        }

        // Only update if winner was below loser (higher position number = lower in pyramid)
        if (winnerPos > loserPos) {
          // Remove winner from current position
          const winner = flatPositions[winnerPos];
          flatPositions.splice(winnerPos, 1);

          // Insert winner at loser's position (pushing loser and everyone between down)
          flatPositions.splice(loserPos, 0, winner);

          // Rebuild pyramid structure
          const newPyramidData = {};
          let idx = 0;
          let levelNum = 1;

          while (idx < flatPositions.length) {
            const levelPlayers = flatPositions.slice(idx, idx + levelNum);
            newPyramidData[`level${levelNum}`] = levelPlayers;
            idx += levelNum;
            levelNum++;
          }

          await db
            .collection("pyramid")
            .doc("current")
            .set({
              ...newPyramidData,
              lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            });
        } else {
        }
      }

      async function initPyramid() {
        const doublesPlayers = state.players.filter((p) => p.doublesPool);

        if (doublesPlayers.length === 0) {
          alert("Keine Spieler im Doppel-Pool!");
          return;
        }

        // Shuffle players
        const shuffled = [...doublesPlayers].sort(() => Math.random() - 0.5);
        const positions = shuffled.map((p) => p.id);

        const levelsObject = buildPyramidLevels(positions);

        const dataToSave = {
          ...levelsObject,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        };

        try {
          await db.collection("pyramid").doc("current").set(dataToSave);
          alert("Pyramide erfolgreich initialisiert!");

          // Force re-read from Firebase
          const doc = await db.collection("pyramid").doc("current").get();
        } catch (error) {
          console.error("‚ùå Fehler beim Initialisieren:", error);
          alert("Fehler: " + error.message);
        }
      }

      async function debugFirebase() {
        try {
          const doc = await db.collection("pyramid").doc("current").get();

          if (doc.exists) {
            const data = doc.data();

            // Check each level
            for (let i = 1; i <= 10; i++) {
              const key = `level${i}`;
              if (data[key]) {
              }
            }

            const levels = pyramidLevelsToArray(data);

            alert(
              "Firebase Check:\nDoc exists: " +
                doc.exists +
                "\nKeys: " +
                Object.keys(data).join(", ") +
                "\nLevels array length: " +
                levels.length
            );
          } else {
            alert("Firebase Dokument existiert nicht!");
          }
        } catch (error) {
          console.error("Debug error:", error);
          alert("Error: " + error.message);
        }
      }

      async function addChallenge() {
        const challenger = document.getElementById("newChallenger").value;
        const challenged = document.getElementById("newChallenged").value;
        const dateStr = document.getElementById("challengeDate").value;

        if (!challenger || !challenged || !dateStr) {
          alert("Bitte alle Felder ausf√ºllen");
          return;
        }

        if (challenger === challenged) {
          alert(
            "Herausforderer und Herausgeforderter m√ºssen unterschiedlich sein"
          );
          return;
        }

        // Validate date
        const selectedDate = new Date(dateStr);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selectedDate < today) {
          alert("Das Datum darf nicht in der Vergangenheit liegen");
          return;
        }

        // Convert to Firestore timestamp
        const timestamp = firebase.firestore.Timestamp.fromDate(selectedDate);

        await db.collection("challenges").add({
          challengerId: challenger,
          challengedId: challenged,
          date: timestamp,
          status: "pending",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        document.getElementById("newChallenger").value = "";
        document.getElementById("newChallenged").value = "";
        document.getElementById("challengeDate").value = "";

        alert("Herausforderung erfolgreich eingetragen!");
      }

      // ============================================
      // RENDER
      // ============================================
      function render() {
        const app = document.getElementById("app");

        let content = "";

        switch (state.currentPage) {
          case "singles":
            content = SinglesPage();
            break;
          case "doubles":
            content = DoublesPage();
            break;
          case "challenges":
            content = ChallengesPage();
            break;
          case "players":
            content = PlayersPage();
            break;
          case "playerProfile":
            content = PlayerProfilePage(state.selectedPlayerId);
            break;
          case "admin":
            content = AdminPage();
            break;
          default:
            content = HomePage();
        }

        app.innerHTML = `
                ${Navigation()}
                <div class="container mx-auto px-4 py-4 sm:py-8 max-w-7xl">
                    ${content}
                </div>
            `;
      }

      // ============================================
      // INIT
      // ============================================

      try {
        initFirebaseListeners();
      } catch (error) {
        console.error("Error stack:", error.stack);
      }

      render();

      // Load pyramid on startup
      loadPyramid();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Vereinsmeisterschaft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION - HIER DEINE CONFIG EINTRAGEN!
        // ============================================
const firebaseConfig = {
  apiKey: "AIzaSyArdTajlSvaUqWh4-LFrhJXOKukn9iecZs",
  authDomain: "cfbgtvereinsmeisterschaft.firebaseapp.com",
  projectId: "cfbgtvereinsmeisterschaft",
  storageBucket: "cfbgtvereinsmeisterschaft.firebasestorage.app",
  messagingSenderId: "527308111102",
  appId: "1:527308111102:web:ef1b52153dd75a6a0c79af",
  measurementId: "G-QKGNPLQN20"
};

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            currentPage: 'home',
            user: null,
            players: [],
            singlesMatches: [],
            doublesMatches: [],
            pyramid: { levels: [] },
            challenges: [],
            editingPlayer: null,
            selectedPlayerId: null,
            matchEntry: {
                set1P1: '', set1P2: '',
                set2P1: '', set2P2: '',
                set3P1: '', set3P2: '',
                set3Disabled: false
            }
        };

        // ============================================
        // FIREBASE LISTENERS
        // ============================================
        function initFirebaseListeners() {
            auth.onAuthStateChanged(user => {
                state.user = user;
                render();
            });

            db.collection('players').orderBy('name').onSnapshot(snapshot => {
                state.players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });

            db.collection('singlesMatches').orderBy('date', 'desc').onSnapshot(snapshot => {
                state.singlesMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });

            db.collection('doublesMatches').orderBy('date', 'desc').onSnapshot(snapshot => {
                state.doublesMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });

            db.collection('pyramid').doc('current').onSnapshot(doc => {
                if (doc.exists) {
                    state.pyramid = doc.data();
                }
                render();
            });

            db.collection('challenges').where('status', '==', 'pending').onSnapshot(snapshot => {
                state.challenges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function getPlayerName(playerId) {
            const player = state.players.find(p => p.id === playerId);
            return player ? player.name : 'Unbekannt';
        }

        function getGroupPlayers(groupNum) {
            return state.players.filter(p => p.singlesGroup === groupNum);
        }

        function calculateStandings(groupNum) {
            const players = getGroupPlayers(groupNum);
            const stats = {};
            
            players.forEach(p => {
                stats[p.id] = {
                    id: p.id,
                    name: p.name,
                    matches: 0,
                    points: 0,
                    setsWon: 0,
                    setsLost: 0
                };
            });

            state.singlesMatches.forEach(match => {
                if (!match.sets) return;
                
                const p1 = match.player1Id;
                const p2 = match.player2Id;
                
                if (!stats[p1] || !stats[p2]) return;

                const sets = match.sets;
                let p1Sets = 0, p2Sets = 0;

                sets.forEach(set => {
                    if (set.p1 > set.p2) p1Sets++;
                    else p2Sets++;
                });

                stats[p1].matches++;
                stats[p2].matches++;
                stats[p1].setsWon += p1Sets;
                stats[p1].setsLost += p2Sets;
                stats[p2].setsWon += p2Sets;
                stats[p2].setsLost += p1Sets;

                if (p1Sets > p2Sets) {
                    stats[p1].points += (p1Sets === 2 && p2Sets === 0) ? 3 : 2;
                    stats[p2].points += (p2Sets === 1) ? 1 : 0;
                } else {
                    stats[p2].points += (p2Sets === 2 && p1Sets === 0) ? 3 : 2;
                    stats[p1].points += (p1Sets === 1) ? 1 : 0;
                }
            });

            return Object.values(stats).sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                const aDiff = a.setsWon - a.setsLost;
                const bDiff = b.setsWon - b.setsLost;
                return bDiff - aDiff;
            });
        }

        function validateSet(p1, p2) {
            const n1 = parseInt(p1);
            const n2 = parseInt(p2);
            
            if (isNaN(n1) || isNaN(n2)) return false;
            if (n1 < 0 || n2 < 0) return false;
            
            // Einer muss mindestens 21 haben
            if (n1 < 21 && n2 < 21) return false;
            
            // Gewinner muss 2 Punkte Vorsprung haben ab 20:20
            if (n1 >= 20 && n2 >= 20) {
                if (Math.abs(n1 - n2) < 2) return false;
            }
            
            // Maximal 30 Punkte
            if (n1 > 30 || n2 > 30) return false;
            
            return true;
        }

        function updateMatchEntry(field, value) {
            state.matchEntry[field] = value;
            
            // Check if third set should be disabled
            const s1p1 = parseInt(state.matchEntry.set1P1);
            const s1p2 = parseInt(state.matchEntry.set1P2);
            const s2p1 = parseInt(state.matchEntry.set2P1);
            const s2p2 = parseInt(state.matchEntry.set2P2);
            
            if (!isNaN(s1p1) && !isNaN(s1p2) && !isNaN(s2p1) && !isNaN(s2p2)) {
                const set1Winner = s1p1 > s1p2 ? 'p1' : 'p2';
                const set2Winner = s2p1 > s2p2 ? 'p1' : 'p2';
                
                // Disable set 3 if someone won 2:0
                if (set1Winner === set2Winner) {
                    state.matchEntry.set3Disabled = true;
                } else {
                    state.matchEntry.set3Disabled = false;
                }
            }
            
            // Don't render, just update the disabled state
            const set3P1Input = document.getElementById('set3P1');
            const set3P2Input = document.getElementById('set3P2');
            if (set3P1Input && set3P2Input) {
                if (state.matchEntry.set3Disabled) {
                    set3P1Input.disabled = true;
                    set3P2Input.disabled = true;
                    set3P1Input.value = '';
                    set3P2Input.value = '';
                    set3P1Input.classList.add('bg-gray-200');
                    set3P2Input.classList.add('bg-gray-200');
                } else {
                    set3P1Input.disabled = false;
                    set3P2Input.disabled = false;
                    set3P1Input.classList.remove('bg-gray-200');
                    set3P2Input.classList.remove('bg-gray-200');
                }
            }
        }

        function getPyramidLevelForPosition(position) {
            let level = 1;
            let posInLevel = position;
            
            while (posInLevel > level) {
                posInLevel -= level;
                level++;
            }
            
            return { level, positionInLevel: posInLevel };
        }

        function buildPyramidLevels(positions) {
            const levels = {};
            let idx = 0;
            let levelNum = 1;
            
            while (idx < positions.length) {
                const levelPlayers = positions.slice(idx, idx + levelNum);
                levels[`level${levelNum}`] = levelPlayers;
                idx += levelNum;
                levelNum++;
            }
            
            return levels;
        }

        function pyramidLevelsToArray(pyramidData) {
            if (!pyramidData) {
                console.log('pyramidLevelsToArray: no data');
                return [];
            }
            
            console.log('pyramidLevelsToArray input:', pyramidData);
            
            const levels = [];
            let levelNum = 1;
            
            while (pyramidData[`level${levelNum}`]) {
                const levelData = pyramidData[`level${levelNum}`];
                console.log(`Level ${levelNum}:`, levelData, 'isArray:', Array.isArray(levelData));
                
                // Firebase stores it as array already!
                if (Array.isArray(levelData)) {
                    levels.push(levelData);
                } else if (typeof levelData === 'string') {
                    // Fallback for string format
                    levels.push(levelData.split(','));
                } else {
                    console.warn(`Level ${levelNum} unexpected type:`, levelData);
                }
                levelNum++;
            }
            
            console.log('pyramidLevelsToArray output:', levels);
            return levels;
        }

        // Load pyramid manually
        async function loadPyramid() {
            console.log('üìä Loading pyramid data...');
            try {
                const doc = await db.collection('pyramid').doc('current').get();
                if (doc.exists) {
                    const data = doc.data();
                    console.log('Pyramid data loaded:', data);
                    const levelsArray = pyramidLevelsToArray(data);
                    state.pyramid = {
                        levels: levelsArray
                    };
                    console.log('‚úÖ Pyramid loaded successfully');
                    render();
                } else {
                    console.log('No pyramid data found');
                    state.pyramid = { levels: [] };
                    render();
                }
            } catch (error) {
                console.error('‚ùå Error loading pyramid:', error);
            }
        }

        // ============================================
        // ICONS
        // ============================================
        const icons = {
            trophy: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>',
            pyramid: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>',
            users: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>',
            settings: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
            plus: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
            edit: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>',
            trash: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>',
            login: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>',
            logout: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>',
            save: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
            x: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
        };

        // ============================================
        // COMPONENTS
        // ============================================
        function Navigation() {
            return `
                <nav class="bg-white shadow-lg">
                    <div class="container mx-auto px-4">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center space-x-8">
                                <h1 class="text-2xl font-bold text-indigo-600 cursor-pointer" onclick="navigateTo('home')">üè∏ Vereinsmeisterschaft</h1>
                                
                                <div class="flex space-x-4">
                                    <button onclick="navigateTo('singles')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${state.currentPage === 'singles' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                                        ${icons.trophy}
                                        <span class="font-medium">Einzel</span>
                                    </button>
                                    <button onclick="navigateTo('doubles')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${state.currentPage === 'doubles' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                                        ${icons.pyramid}
                                        <span class="font-medium">Doppel</span>
                                    </button>
                                    <button onclick="navigateTo('players')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${state.currentPage === 'players' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                                        ${icons.users}
                                        <span class="font-medium">Spieler</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                ${state.user ? `
                                    <button onclick="navigateTo('admin')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${state.currentPage === 'admin' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'}">
                                        ${icons.settings}
                                        <span class="font-medium">Admin</span>
                                    </button>
                                    <button onclick="handleLogout()" class="flex items-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                        ${icons.logout}
                                        <span>Logout</span>
                                    </button>
                                ` : `
                                    <button onclick="navigateTo('admin')" class="flex items-center space-x-2 px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                        ${icons.login}
                                        <span>Admin Login</span>
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </nav>
            `;
        }

        function HomePage() {
            const recentMatches = [...state.singlesMatches, ...state.doublesMatches]
                .sort((a, b) => {
                    const aTime = a.date?.seconds || 0;
                    const bTime = b.date?.seconds || 0;
                    return bTime - aTime;
                })
                .slice(0, 5);

            return `
                <div class="space-y-8">
                    <div class="text-center">
                        <h2 class="text-4xl font-bold text-gray-800 mb-4">Willkommen zur Vereinsmeisterschaft</h2>
                        <p class="text-xl text-gray-600">Aktuell ${state.players.length} registrierte Spieler</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div onclick="navigateTo('singles')" class="bg-white rounded-xl shadow-lg p-8 cursor-pointer hover:shadow-xl transition-shadow">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="text-yellow-500">${icons.trophy}</div>
                                <h3 class="text-2xl font-bold text-gray-800">Einzel-Turnier</h3>
                            </div>
                            <p class="text-gray-600">Gruppenphasen mit anschlie√üendem K.O.-System</p>
                        </div>
                        
                        <div onclick="navigateTo('doubles')" class="bg-white rounded-xl shadow-lg p-8 cursor-pointer hover:shadow-xl transition-shadow">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="text-blue-500">${icons.pyramid}</div>
                                <h3 class="text-2xl font-bold text-gray-800">Doppel-Pyramide</h3>
                            </div>
                            <p class="text-gray-600">Herausforderungs-System mit dynamischer Rangfolge</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Letzte Ergebnisse</h3>
                        ${recentMatches.length === 0 ? `
                            <p class="text-gray-500 text-center py-8">Noch keine Spiele eingetragen</p>
                        ` : `
                            <div class="space-y-3">
                                ${recentMatches.map(match => {
                                    const scoreText = match.sets ? 
                                        match.sets.map(s => `${s.p1}:${s.p2}`).join(', ') : 
                                        'Ausstehend';
                                    return `
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <span class="font-medium">${getPlayerName(match.player1Id)} vs ${getPlayerName(match.player2Id)}</span>
                                            <span class="text-indigo-600 font-bold">${scoreText}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function SinglesPage() {
            const group1 = calculateStandings(1);
            const group2 = calculateStandings(2);

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Einzel-Turnier</h2>
                        
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            ${GroupTable(1, group1)}
                            ${GroupTable(2, group2)}
                        </div>
                        
                        ${state.user ? SinglesMatchEntry() : ''}
                    </div>
                </div>
            `;
        }

        function GroupTable(groupNum, standings) {
            return `
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Gruppe ${groupNum}</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-gray-600 border-b">
                                <th class="pb-2">Platz</th>
                                <th class="pb-2">Spieler</th>
                                <th class="pb-2">Sp</th>
                                <th class="pb-2">Pkt</th>
                                <th class="pb-2">S√§tze</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${standings.length === 0 ? `
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-gray-500">Keine Spieler in Gruppe ${groupNum}</td>
                                </tr>
                            ` : standings.map((player, idx) => `
                                <tr class="border-b border-gray-200">
                                    <td class="py-2 font-bold">${idx + 1}</td>
                                    <td class="py-2">${player.name}</td>
                                    <td class="py-2">${player.matches}</td>
                                    <td class="py-2 font-semibold">${player.points}</td>
                                    <td class="py-2">${player.setsWon}:${player.setsLost}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function SinglesMatchEntry() {
            const group1Players = getGroupPlayers(1);
            const group2Players = getGroupPlayers(2);
            const allSinglesPlayers = [...group1Players, ...group2Players];

            return `
                <div class="p-4 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-3">Neues Einzel-Spiel eintragen</h4>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <select id="singlesP1" class="px-3 py-2 border rounded-lg">
                            <option value="">Spieler 1 w√§hlen</option>
                            ${allSinglesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                        <select id="singlesP2" class="px-3 py-2 border rounded-lg">
                            <option value="">Spieler 2 w√§hlen</option>
                            ${allSinglesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Spieler 1</label>
                                <input type="number" id="set1P1" min="0" max="30" 
                                    oninput="updateMatchEntry('set1P1', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Spieler 2</label>
                                <input type="number" id="set1P2" min="0" max="30"
                                    oninput="updateMatchEntry('set1P2', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Spieler 1</label>
                                <input type="number" id="set2P1" min="0" max="30"
                                    oninput="updateMatchEntry('set2P1', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Spieler 2</label>
                                <input type="number" id="set2P2" min="0" max="30"
                                    oninput="updateMatchEntry('set2P2', this.value)"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Spieler 1</label>
                                <input type="number" id="set3P1" min="0" max="30"
                                    oninput="updateMatchEntry('set3P1', this.value)"
                                    ${state.matchEntry.set3Disabled ? 'disabled' : ''}
                                    class="w-full px-3 py-2 border rounded-lg ${state.matchEntry.set3Disabled ? 'bg-gray-200' : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Spieler 2</label>
                                <input type="number" id="set3P2" min="0" max="30"
                                    oninput="updateMatchEntry('set3P2', this.value)"
                                    ${state.matchEntry.set3Disabled ? 'disabled' : ''}
                                    class="w-full px-3 py-2 border rounded-lg ${state.matchEntry.set3Disabled ? 'bg-gray-200' : ''}">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="addSinglesMatch()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Spiel eintragen
                    </button>
                </div>
            `;
        }

        function DoublesPage() {
            const levels = state.pyramid.levels || [];

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Doppel-Pyramide</h2>
                        
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold mb-3">Aktuelle Rangfolge</h3>
                            ${levels.length === 0 ? `
                                <div class="text-center py-12 bg-gray-50 rounded-lg">
                                    <div class="text-blue-500 mb-4">${icons.pyramid}</div>
                                    <p class="text-gray-600">Pyramide noch nicht initialisiert</p>
                                    ${state.user ? `
                                        <button onclick="initPyramid()" class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                            Pyramide initialisieren
                                        </button>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    ${levels.map((level, levelIdx) => `
                                        <div class="flex justify-center items-center space-x-4" >
                                            ${level.map((playerId, posIdx) => `
                                                <div class="relative">
                                                    <div class="bg-gradient-to-r from-yellow-100 to-orange-100 border-2 border-yellow-500 rounded-lg px-4 py-3 text-center shadow-md min-w-[120px]">
                                                        <div class="text-xs text-gray-500 mb-1">Position ${posIdx + 1}</div>
                                                        <div class="font-bold text-gray-800">${getPlayerName(playerId)}</div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold mb-3">Anstehende Herausforderungen</h3>
                            ${state.challenges.length === 0 ? `
                                <div class="text-center py-8 bg-gray-50 rounded-lg">
                                    <p class="text-gray-500">Keine anstehenden Herausforderungen</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${state.challenges.map(challenge => `
                                        <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                            <div class="flex items-center justify-between">
                                                <span class="font-medium">${getPlayerName(challenge.challengerId)} fordert ${getPlayerName(challenge.challengedId)} heraus</span>
                                                <span class="text-sm text-gray-500">Offen</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        
                        ${state.user && levels.length > 0 ? DoublesMatchEntry() : ''}
                    </div>
                </div>
            `;
        }

        function DoublesMatchEntry() {
            const doublesPlayers = state.players.filter(p => p.doublesPool);

            return `
                <div class="space-y-6">
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-bold text-gray-800 mb-3">Neue Herausforderung eintragen</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <select id="challenger" class="px-3 py-2 border rounded-lg">
                                <option value="">Herausforderer</option>
                                ${doublesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                            <select id="challenged" class="px-3 py-2 border rounded-lg">
                                <option value="">Herausgeforderter</option>
                                ${doublesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                            <button onclick="addChallenge()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                Eintragen
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <h4 class="font-bold text-gray-800 mb-3">Doppel-Spiel eintragen</h4>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Team 1</label>
                                <select id="doublesT1P1" class="w-full px-3 py-2 border rounded-lg mb-2">
                                    <option value="">Spieler 1</option>
                                    ${doublesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                                <select id="doublesT1P2" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Spieler 2</option>
                                    ${doublesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Team 2</label>
                                <select id="doublesT2P1" class="w-full px-3 py-2 border rounded-lg mb-2">
                                    <option value="">Spieler 1</option>
                                    ${doublesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                                <select id="doublesT2P2" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Spieler 2</option>
                                    ${doublesPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="isChallenge" class="rounded">
                                <span class="text-sm text-gray-700">Dies ist eine Herausforderung (z√§hlt f√ºr Pyramide)</span>
                            </label>
                        </div>
                        
                        <div class="space-y-3 mb-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Team 1</label>
                                    <input type="number" id="doublesSet1T1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Satz 1 - Team 2</label>
                                    <input type="number" id="doublesSet1T2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Team 1</label>
                                    <input type="number" id="doublesSet2T1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Satz 2 - Team 2</label>
                                    <input type="number" id="doublesSet2T2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Team 1</label>
                                    <input type="number" id="doublesSet3T1" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Satz 3 - Team 2</label>
                                    <input type="number" id="doublesSet3T2" min="0" max="30" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="addDoublesMatch()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            Doppel-Spiel eintragen
                        </button>
                    </div>
                </div>
            `;
        }

        function PlayersPage() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Alle Spieler</h2>
                    
                    ${state.players.length === 0 ? `
                        <p class="text-center py-8 text-gray-500">Noch keine Spieler registriert</p>
                    ` : `
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${state.players.map(player => `
                                <div onclick="viewPlayerProfile('${player.id}')" class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors">
                                    <h3 class="text-lg font-bold text-gray-800">${player.name}</h3>
                                    <div class="text-sm text-gray-600 mt-2 space-y-1">
                                        ${player.singlesGroup ? `<div>Einzel: Gruppe ${player.singlesGroup}</div>` : ''}
                                        ${player.doublesPool ? `<div>Doppel: Pool ${player.doublesPool}</div>` : ''}
                                        ${!player.singlesGroup && !player.doublesPool ? '<div class="text-gray-400">Kein Turnier</div>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function PlayerProfilePage(playerId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return '<div>Spieler nicht gefunden</div>';

            const singlesMatches = state.singlesMatches.filter(m => 
                m.player1Id === playerId || m.player2Id === playerId
            );

            const doublesMatches = state.doublesMatches.filter(m =>
                m.team1.player1Id === playerId || m.team1.player2Id === playerId ||
                m.team2.player1Id === playerId || m.team2.player2Id === playerId
            );

            let singlesWins = 0, singlesLosses = 0;
            singlesMatches.forEach(match => {
                if (!match.sets || match.sets.length < 2) return;
                let p1Sets = 0, p2Sets = 0;
                match.sets.forEach(set => {
                    if (set.p1 > set.p2) p1Sets++;
                    else p2Sets++;
                });
                
                const isPlayer1 = match.player1Id === playerId;
                if ((isPlayer1 && p1Sets > p2Sets) || (!isPlayer1 && p2Sets > p1Sets)) {
                    singlesWins++;
                } else {
                    singlesLosses++;
                }
            });

            return `
                <div class="space-y-6">
                    <button onclick="navigateTo('players')" class="text-indigo-600 hover:text-indigo-800 flex items-center space-x-2">
                        <span>‚Üê Zur√ºck zu allen Spielern</span>
                    </button>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">${player.name}</h2>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <div class="text-sm text-gray-600 mb-1">Einzel-Bilanz</div>
                                <div class="text-2xl font-bold text-gray-800">${singlesWins}:${singlesLosses}</div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="text-sm text-gray-600 mb-1">Doppel-Spiele</div>
                                <div class="text-2xl font-bold text-gray-800">${doublesMatches.length}</div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            ${singlesMatches.length > 0 ? `
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">Einzel-Spiele</h3>
                                    <div class="space-y-2">
                                        ${singlesMatches.map(match => {
                                            const isPlayer1 = match.player1Id === playerId;
                                            const opponent = isPlayer1 ? getPlayerName(match.player2Id) : getPlayerName(match.player1Id);
                                            const scoreText = match.sets ? match.sets.map(s => `${s.p1}:${s.p2}`).join(', ') : 'Ausstehend';
                                            
                                            let result = '';
                                            if (match.sets && match.sets.length >= 2) {
                                                let p1Sets = 0, p2Sets = 0;
                                                match.sets.forEach(set => {
                                                    if (set.p1 > set.p2) p1Sets++;
                                                    else p2Sets++;
                                                });
                                                const won = (isPlayer1 && p1Sets > p2Sets) || (!isPlayer1 && p2Sets > p1Sets);
                                                result = won ? 'Sieg' : 'Niederlage';
                                            }

                                            return `
                                                <div class="p-3 ${result === 'Sieg' ? 'bg-green-50' : result === 'Niederlage' ? 'bg-red-50' : 'bg-gray-50'} rounded-lg">
                                                    <div class="flex justify-between items-center">
                                                        <span class="font-medium">vs ${opponent}</span>
                                                        <div class="text-right">
                                                            <span class="font-bold ${result === 'Sieg' ? 'text-green-600' : result === 'Niederlage' ? 'text-red-600' : 'text-gray-600'}">${result || 'Offen'}</span>
                                                            <div class="text-sm text-gray-600">${scoreText}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${doublesMatches.length > 0 ? `
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">Doppel-Spiele</h3>
                                    <div class="space-y-2">
                                        ${doublesMatches.map(match => {
                                            const isTeam1 = match.team1.player1Id === playerId || match.team1.player2Id === playerId;
                                            const partner = isTeam1 ? 
                                                getPlayerName(match.team1.player1Id === playerId ? match.team1.player2Id : match.team1.player1Id) :
                                                getPlayerName(match.team2.player1Id === playerId ? match.team2.player2Id : match.team2.player1Id);
                                            const opponents = isTeam1 ?
                                                `${getPlayerName(match.team2.player1Id)} / ${getPlayerName(match.team2.player2Id)}` :
                                                `${getPlayerName(match.team1.player1Id)} / ${getPlayerName(match.team1.player2Id)}`;
                                            const scoreText = match.sets ? match.sets.map(s => `${s.t1}:${s.t2}`).join(', ') : 'Ausstehend';
                                            
                                            let result = '';
                                            if (match.sets && match.sets.length >= 2) {
                                                let t1Sets = 0, t2Sets = 0;
                                                match.sets.forEach(set => {
                                                    if (set.t1 > set.t2) t1Sets++;
                                                    else t2Sets++;
                                                });
                                                const won = (isTeam1 && t1Sets > t2Sets) || (!isTeam1 && t2Sets > t1Sets);
                                                result = won ? 'Sieg' : 'Niederlage';
                                            }

                                            return `
                                                <div class="p-3 ${result === 'Sieg' ? 'bg-green-50' : result === 'Niederlage' ? 'bg-red-50' : 'bg-gray-50'} rounded-lg">
                                                    <div class="flex justify-between items-center">
                                                        <div>
                                                            <div class="font-medium">mit ${partner}</div>
                                                            <div class="text-sm text-gray-600">vs ${opponents}</div>
                                                            ${match.isChallenge ? '<div class="text-xs text-blue-600 mt-1">‚ö° Herausforderung</div>' : ''}
                                                        </div>
                                                        <div class="text-right">
                                                            <span class="font-bold ${result === 'Sieg' ? 'text-green-600' : result === 'Niederlage' ? 'text-red-600' : 'text-gray-600'}">${result || 'Offen'}</span>
                                                            <div class="text-sm text-gray-600">${scoreText}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${singlesMatches.length === 0 && doublesMatches.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    Noch keine Spiele f√ºr diesen Spieler
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function AdminPage() {
            if (!state.user) {
                return `
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-xl shadow-lg p-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Admin Login</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="admin@verein.de">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Passwort</label>
                                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Passwort">
                                </div>
                                <div id="loginError" class="text-red-500 text-sm hidden"></div>
                                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                    Anmelden
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Spielerverwaltung</h2>
                        
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3">Neuen Spieler hinzuf√ºgen</h4>
                            <div class="flex space-x-3">
                                <input type="text" id="playerName" placeholder="Name" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                                <button onclick="addPlayer()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2">
                                    ${icons.plus}
                                    <span>Hinzuf√ºgen</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            ${state.players.map(player => `
                                ${state.editingPlayer === player.id ? `
                                    <div class="p-4 bg-blue-50 border-2 border-blue-500 rounded-lg">
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                                <input type="text" id="editName_${player.id}" value="${player.name}" class="w-full px-3 py-2 border rounded-lg">
                                            </div>
                                            
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Einzel-Gruppe</label>
                                                    <select id="editSingles_${player.id}" class="w-full px-3 py-2 border rounded-lg">
                                                        <option value="">Nicht dabei</option>
                                                        <option value="1" ${player.singlesGroup === 1 ? 'selected' : ''}>Gruppe 1</option>
                                                        <option value="2" ${player.singlesGroup === 2 ? 'selected' : ''}>Gruppe 2</option>
                                                    </select>
                                                </div>
                                                
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Doppel-Pool</label>
                                                    <select id="editDoubles_${player.id}" class="w-full px-3 py-2 border rounded-lg">
                                                        <option value="">Nicht dabei</option>
                                                        <option value="A" ${player.doublesPool === 'A' ? 'selected' : ''}>Pool A (stark)</option>
                                                        <option value="B" ${player.doublesPool === 'B' ? 'selected' : ''}>Pool B (schwach)</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="flex space-x-2">
                                                <button onclick="savePlayer('${player.id}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center space-x-2">
                                                    ${icons.save}
                                                    <span>Speichern</span>
                                                </button>
                                                <button onclick="cancelEdit()" class="flex-1 px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 flex items-center justify-center space-x-2">
                                                    ${icons.x}
                                                    <span>Abbrechen</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:border-gray-300">
                                        <div>
                                            <span class="font-medium text-gray-800">${player.name}</span>
                                            <div class="text-sm text-gray-500 mt-1">
                                                ${player.singlesGroup ? `Einzel: Gruppe ${player.singlesGroup}` : ''}
                                                ${player.singlesGroup && player.doublesPool ? ' ‚Ä¢ ' : ''}
                                                ${player.doublesPool ? `Doppel: Pool ${player.doublesPool}` : ''}
                                                ${!player.singlesGroup && !player.doublesPool ? 'Nimmt nicht teil' : ''}
                                            </div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="editPlayer('${player.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors">
                                                ${icons.edit}
                                            </button>
                                            <button onclick="deletePlayer('${player.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded transition-colors">
                                                ${icons.trash}
                                            </button>
                                        </div>
                                    </div>
                                `}
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        function navigateTo(page) {
            state.currentPage = page;
            state.selectedPlayerId = null;
            render();
        }

        function viewPlayerProfile(playerId) {
            state.selectedPlayerId = playerId;
            state.currentPage = 'playerProfile';
            render();
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                state.currentPage = 'admin';
            } catch (error) {
                errorDiv.textContent = 'Login fehlgeschlagen: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            await auth.signOut();
            state.currentPage = 'home';
        }

        async function addPlayer() {
            const name = document.getElementById('playerName').value.trim();
            
            if (name) {
                await db.collection('players').add({
                    name,
                    singlesGroup: null,
                    doublesPool: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('playerName').value = '';
            }
        }

        function editPlayer(playerId) {
            state.editingPlayer = playerId;
            render();
        }

        function cancelEdit() {
            state.editingPlayer = null;
            render();
        }

        async function savePlayer(playerId) {
            const name = document.getElementById(`editName_${playerId}`).value.trim();
            const singlesGroup = document.getElementById(`editSingles_${playerId}`).value;
            const doublesPool = document.getElementById(`editDoubles_${playerId}`).value;
            
            if (name) {
                await db.collection('players').doc(playerId).update({
                    name,
                    singlesGroup: singlesGroup ? parseInt(singlesGroup) : null,
                    doublesPool: doublesPool || null
                });
                
                state.editingPlayer = null;
                render();
            }
        }

        async function deletePlayer(playerId) {
            if (confirm('Spieler wirklich l√∂schen?')) {
                await db.collection('players').doc(playerId).delete();
            }
        }

        async function addSinglesMatch() {
            const p1 = document.getElementById('singlesP1').value;
            const p2 = document.getElementById('singlesP2').value;
            
            const set1P1 = parseInt(document.getElementById('set1P1').value);
            const set1P2 = parseInt(document.getElementById('set1P2').value);
            const set2P1 = parseInt(document.getElementById('set2P1').value);
            const set2P2 = parseInt(document.getElementById('set2P2').value);
            const set3P1 = parseInt(document.getElementById('set3P1').value);
            const set3P2 = parseInt(document.getElementById('set3P2').value);
            
            if (!p1 || !p2 || p1 === p2) {
                alert('Bitte zwei verschiedene Spieler ausw√§hlen');
                return;
            }
            
            if (!validateSet(set1P1, set1P2) || !validateSet(set2P1, set2P2)) {
                alert('Ung√ºltige Satz-Ergebnisse in Satz 1 oder 2');
                return;
            }
            
            const sets = [
                { p1: set1P1, p2: set1P2 },
                { p1: set2P1, p2: set2P2 }
            ];
            
            const set1Winner = set1P1 > set1P2 ? 'p1' : 'p2';
            const set2Winner = set2P1 > set2P2 ? 'p1' : 'p2';
            
            // Check if set 3 is needed
            if (set1Winner !== set2Winner) {
                if (!isNaN(set3P1) && !isNaN(set3P2)) {
                    if (!validateSet(set3P1, set3P2)) {
                        alert('Ung√ºltiges Satz-Ergebnis in Satz 3');
                        return;
                    }
                    sets.push({ p1: set3P1, p2: set3P2 });
                } else {
                    alert('Dritter Satz ist erforderlich (Spielstand 1:1)');
                    return;
                }
            } else if (!isNaN(set3P1) || !isNaN(set3P2)) {
                alert('Dritter Satz nicht erlaubt (Spielstand bereits 2:0)');
                return;
            }
            
            await db.collection('singlesMatches').add({
                player1Id: p1,
                player2Id: p2,
                sets,
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Reset form
            document.getElementById('singlesP1').value = '';
            document.getElementById('singlesP2').value = '';
            document.getElementById('set1P1').value = '';
            document.getElementById('set1P2').value = '';
            document.getElementById('set2P1').value = '';
            document.getElementById('set2P2').value = '';
            document.getElementById('set3P1').value = '';
            document.getElementById('set3P2').value = '';
            
            state.matchEntry = {
                set1P1: '', set1P2: '',
                set2P1: '', set2P2: '',
                set3P1: '', set3P2: '',
                set3Disabled: false
            };
            
            alert('Spiel erfolgreich eingetragen!');
            render();
        }

        async function addDoublesMatch() {
            const t1p1 = document.getElementById('doublesT1P1').value;
            const t1p2 = document.getElementById('doublesT1P2').value;
            const t2p1 = document.getElementById('doublesT2P1').value;
            const t2p2 = document.getElementById('doublesT2P2').value;
            const isChallenge = document.getElementById('isChallenge').checked;
            
            const set1T1 = parseInt(document.getElementById('doublesSet1T1').value);
            const set1T2 = parseInt(document.getElementById('doublesSet1T2').value);
            const set2T1 = parseInt(document.getElementById('doublesSet2T1').value);
            const set2T2 = parseInt(document.getElementById('doublesSet2T2').value);
            const set3T1 = parseInt(document.getElementById('doublesSet3T1').value);
            const set3T2 = parseInt(document.getElementById('doublesSet3T2').value);
            
            if (!t1p1 || !t1p2 || !t2p1 || !t2p2) {
                alert('Bitte alle 4 Spieler ausw√§hlen');
                return;
            }
            
            if (!validateSet(set1T1, set1T2) || !validateSet(set2T1, set2T2)) {
                alert('Ung√ºltige Satz-Ergebnisse');
                return;
            }
            
            const sets = [
                { t1: set1T1, t2: set1T2 },
                { t1: set2T1, t2: set2T2 }
            ];
            
            const set1Winner = set1T1 > set1T2 ? 't1' : 't2';
            const set2Winner = set2T1 > set2T2 ? 't1' : 't2';
            
            if (set1Winner !== set2Winner) {
                if (!isNaN(set3T1) && !isNaN(set3T2)) {
                    if (!validateSet(set3T1, set3T2)) {
                        alert('Ung√ºltiges Satz-Ergebnis in Satz 3');
                        return;
                    }
                    sets.push({ t1: set3T1, t2: set3T2 });
                } else {
                    alert('Dritter Satz ist erforderlich');
                    return;
                }
            }
            
            await db.collection('doublesMatches').add({
                team1: { player1Id: t1p1, player2Id: t1p2 },
                team2: { player1Id: t2p1, player2Id: t2p2 },
                sets,
                isChallenge,
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update pyramid if isChallenge
            if (isChallenge) {
                let t1Sets = 0, t2Sets = 0;
                sets.forEach(set => {
                    if (set.t1 > set.t2) t1Sets++;
                    else t2Sets++;
                });
                
                const winnerId = t1Sets > t2Sets ? t1p1 : t2p1;
                const loserId = t1Sets > t2Sets ? t2p1 : t1p1;
                
                await updatePyramidAfterChallenge(winnerId, loserId);
                
                // Reload pyramid after update (with delay to ensure Firestore has written)
                setTimeout(() => {
                    loadPyramid();
                }, 1000);
            }
            
            alert('Doppel-Spiel erfolgreich eingetragen!');
            render();
        }

        async function updatePyramidAfterChallenge(winnerId, loserId) {
            const pyramidDoc = await db.collection('pyramid').doc('current').get();
            if (!pyramidDoc.exists) return;
            
            const pyramidData = pyramidDoc.data();
            const levels = pyramidLevelsToArray(pyramidData);
            
            // Find positions
            let winnerPos = -1, loserPos = -1;
            let flatPositions = [];
            levels.forEach(level => {
                level.forEach(playerId => {
                    flatPositions.push(playerId);
                });
            });
            
            winnerPos = flatPositions.indexOf(winnerId);
            loserPos = flatPositions.indexOf(loserId);
            
            if (winnerPos === -1 || loserPos === -1) return;
            
            // Winner was below loser and won, so swap them
            if (winnerPos > loserPos) {
                // Swap positions
                flatPositions[winnerPos] = loserId;
                flatPositions[loserPos] = winnerId;
                
                // Rebuild levels as arrays
                const newPyramidData = {};
                let idx = 0;
                let levelNum = 1;
                
                while (idx < flatPositions.length) {
                    const levelPlayers = flatPositions.slice(idx, idx + levelNum);
                    newPyramidData[`level${levelNum}`] = levelPlayers;
                    idx += levelNum;
                    levelNum++;
                }
                
                await db.collection('pyramid').doc('current').set({
                    ...newPyramidData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        async function initPyramid() {
            console.log('=== INIT PYRAMID START ===');
            
            const doublesPlayers = state.players.filter(p => p.doublesPool);
            console.log('Doppel-Spieler gefunden:', doublesPlayers);
            
            if (doublesPlayers.length === 0) {
                alert('Keine Spieler im Doppel-Pool!');
                return;
            }
            
            // Shuffle players
            const shuffled = [...doublesPlayers].sort(() => Math.random() - 0.5);
            const positions = shuffled.map(p => p.id);
            console.log('Positionen (IDs):', positions);
            
            const levelsObject = buildPyramidLevels(positions);
            console.log('Levels Object:', levelsObject);
            
            const dataToSave = {
                ...levelsObject,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            console.log('Data to save:', dataToSave);
            
            try {
                await db.collection('pyramid').doc('current').set(dataToSave);
                console.log('‚úÖ Pyramide gespeichert!');
                alert('Pyramide erfolgreich initialisiert!');
                
                // Force re-read from Firebase
                const doc = await db.collection('pyramid').doc('current').get();
                console.log('Nach Speichern - Firebase Doc exists:', doc.exists);
                console.log('Nach Speichern - Firebase Data:', doc.data());
            } catch (error) {
                console.error('‚ùå Fehler beim Initialisieren:', error);
                alert('Fehler: ' + error.message);
            }
        }

        async function debugFirebase() {
            console.log('=== FIREBASE DEBUG ===');
            try {
                const doc = await db.collection('pyramid').doc('current').get();
                console.log('Doc exists:', doc.exists);
                
                if (doc.exists) {
                    const data = doc.data();
                    console.log('Raw data:', data);
                    console.log('Data keys:', Object.keys(data));
                    
                    // Check each level
                    for (let i = 1; i <= 10; i++) {
                        const key = `level${i}`;
                        if (data[key]) {
                            console.log(`${key}:`, data[key], 'isArray:', Array.isArray(data[key]));
                        }
                    }
                    
                    const levels = pyramidLevelsToArray(data);
                    console.log('Converted to array:', levels);
                    
                    alert('Firebase Check:\nDoc exists: ' + doc.exists + '\nKeys: ' + Object.keys(data).join(', ') + '\nLevels array length: ' + levels.length);
                } else {
                    alert('Firebase Dokument existiert nicht!');
                }
            } catch (error) {
                console.error('Debug error:', error);
                alert('Error: ' + error.message);
            }
        }

        async function addChallenge() {
            const challenger = document.getElementById('challenger').value;
            const challenged = document.getElementById('challenged').value;
            
            if (!challenger || !challenged || challenger === challenged) {
                alert('Bitte zwei verschiedene Spieler ausw√§hlen');
                return;
            }
            
            await db.collection('challenges').add({
                challengerId: challenger,
                challengedId: challenged,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            document.getElementById('challenger').value = '';
            document.getElementById('challenged').value = '';
            
            alert('Herausforderung eingetragen!');
        }

        // ============================================
        // RENDER
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            let content = '';
            
            switch (state.currentPage) {
                case 'singles':
                    content = SinglesPage();
                    break;
                case 'doubles':
                    content = DoublesPage();
                    break;
                case 'players':
                    content = PlayersPage();
                    break;
                case 'playerProfile':
                    content = PlayerProfilePage(state.selectedPlayerId);
                    break;
                case 'admin':
                    content = AdminPage();
                    break;
                default:
                    content = HomePage();
            }
            
            app.innerHTML = `
                ${Navigation()}
                <div class="container mx-auto px-4 py-8 max-w-7xl">
                    ${content}
                </div>
            `;
        }

        // ============================================
        // INIT
        // ============================================
        console.log('üöÄ Starting application...');
        console.log('Firebase initialized:', typeof firebase !== 'undefined');
        console.log('Firestore initialized:', typeof db !== 'undefined');
        
        try {
            console.log('Attempting to initialize listeners...');
            initFirebaseListeners();
            console.log('Listeners initialized successfully');
        } catch (error) {
            console.error('‚ùå‚ùå‚ùå CRITICAL ERROR initializing listeners:', error);
            console.error('Error stack:', error.stack);
        }
        
        render();
        
        console.log('‚úÖ Application started');
        
        // Load pyramid on startup
        loadPyramid();
    </script>
</body>
</html>